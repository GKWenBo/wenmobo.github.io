<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-flash.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "69a9214b"
    });
  daovoice('update');
  </script>















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS,SDWebImage," />





  <link rel="alternate" href="/atom.xml" title="Mr.Wen" type="application/atom+xml" />






<meta name="description" content="笔者在业余时间对iOS著名图片加载框架[SDWebImage ](https://github.com/SDWebImage/SDWebImage)**V5.8.0**源码进行了阅读，发现和V5.0之前版本架构设计有很大的不同，V5.0之后的版本是面向协议的架构设计，将图片缓存、编码解码、下载、自定义转换定义了一套标准协议方法，使用者想自定义一些操作，通过遵循协议，可以很方便的进行扩展。总之，SD">
<meta name="keywords" content="iOS,SDWebImage">
<meta property="og:type" content="article">
<meta property="og:title" content="读SDWebImage源码心得">
<meta property="og:url" content="http://blogwenbo.com/2020/06/07/读SDWebImage源码心得/index.html">
<meta property="og:site_name" content="Mr.Wen">
<meta property="og:description" content="笔者在业余时间对iOS著名图片加载框架[SDWebImage ](https://github.com/SDWebImage/SDWebImage)**V5.8.0**源码进行了阅读，发现和V5.0之前版本架构设计有很大的不同，V5.0之后的版本是面向协议的架构设计，将图片缓存、编码解码、下载、自定义转换定义了一套标准协议方法，使用者想自定义一些操作，通过遵循协议，可以很方便的进行扩展。总之，SD">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr6cmcxxj30sg0lcjtb.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr7pni02j30zo0u0gwu.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr8tfo67j31ac0hn438.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr9lek4rj31110dk0uo.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjrxs5kkfj30u00xb4lh.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjtj8emsuj311p0u0478.jpg">
<meta property="og:updated_time" content="2020-06-08T13:26:58.512Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="读SDWebImage源码心得">
<meta name="twitter:description" content="笔者在业余时间对iOS著名图片加载框架[SDWebImage ](https://github.com/SDWebImage/SDWebImage)**V5.8.0**源码进行了阅读，发现和V5.0之前版本架构设计有很大的不同，V5.0之后的版本是面向协议的架构设计，将图片缓存、编码解码、下载、自定义转换定义了一套标准协议方法，使用者想自定义一些操作，通过遵循协议，可以很方便的进行扩展。总之，SD">
<meta name="twitter:image" content="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr6cmcxxj30sg0lcjtb.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blogwenbo.com/2020/06/07/读SDWebImage源码心得/"/>





  <title>读SDWebImage源码心得 | Mr.Wen</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/wenmobo" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mr.Wen</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">To strive, to seek, to find, and not to yield</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-top">
          <a href="/top/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-signal"></i> <br />
            
            阅读排行
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blogwenbo.com/2020/06/07/读SDWebImage源码心得/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Mr.Wen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://upload.jianshu.io/users/upload_avatars/3072214/ccbcba49-0a5c-4b7e-b1e4-aea15ab4419f.png?imageMogr2/auto-orient/strip|imageView2/1/w/240/h/240">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mr.Wen">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">读SDWebImage源码心得</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-07T15:17:52+08:00">
                2020-06-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2020/06/07/读SDWebImage源码心得/" class="leancloud_visitors" data-flag-title="读SDWebImage源码心得">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span><span>℃</span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  9,366
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  54
                </span>
              
            </div>
          

          
              <div class="post-description">
                  笔者在业余时间对iOS著名图片加载框架[SDWebImage ](https://github.com/SDWebImage/SDWebImage)**V5.8.0**源码进行了阅读，发现和V5.0之前版本架构设计有很大的不同，V5.0之后的版本是面向协议的架构设计，将图片缓存、编码解码、下载、自定义转换定义了一套标准协议方法，使用者想自定义一些操作，通过遵循协议，可以很方便的进行扩展。总之，SDWebImage源码是非常值得阅读，它应用了软件设计原则，和设计模式，使软件架构层次清晰，更容易理解阅读，扩展。SDWebImage源码还是有点多的，笔者零零散散花了几天，对源码粗略的读了一遍，收获还是颇多的，由于笔者现在水平有限，对于有些源码理解不是很到位，有理解描述不对的地方，希望能批评指正。
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p class="description"></p>

<a id="more"></a>
<h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><blockquote>
<p>笔者在业余时间对iOS著名图片加载框架<a href="https://github.com/SDWebImage/SDWebImage" target="_blank" rel="noopener">SDWebImage </a><strong>V5.8.0</strong>源码进行了阅读，发现和V5.0之前版本架构设计有很大的不同，V5.0之后的版本是面向协议的架构设计，将图片缓存、编码解码、下载、自定义转换定义了一套标准协议方法，使用者想自定义一些操作，通过遵循协议，可以很方便的进行扩展。总之，SDWebImage源码是非常值得阅读，它应用了软件设计原则，和设计模式，使软件架构层次清晰，更容易理解阅读，扩展。SDWebImage源码还是有点多的，笔者零零散散花了几天，对源码粗略的读了一遍，收获还是颇多的，由于笔者现在水平有限，对于有些源码理解不是很到位，有理解描述不对的地方，希望能批评指正。</p>
</blockquote>
<h2 id="二、官方架构图解"><a href="#二、官方架构图解" class="headerlink" title="二、官方架构图解"></a>二、官方架构图解</h2><h3 id="High-Level-Diagram"><a href="#High-Level-Diagram" class="headerlink" title="High Level Diagram"></a>High Level Diagram</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr6cmcxxj30sg0lcjtb.jpg" alt=""></p>
<h3 id="Overall-Class-Diagram"><a href="#Overall-Class-Diagram" class="headerlink" title="Overall Class Diagram"></a>Overall Class Diagram</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr7pni02j30zo0u0gwu.jpg" alt=""></p>
<h3 id="Top-Level-API-Diagram"><a href="#Top-Level-API-Diagram" class="headerlink" title="Top Level API Diagram"></a>Top Level API Diagram</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr8tfo67j31ac0hn438.jpg" alt=""></p>
<h3 id="Main-Sequence-Diagram"><a href="#Main-Sequence-Diagram" class="headerlink" title="Main Sequence Diagram"></a>Main Sequence Diagram</h3><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjr9lek4rj31110dk0uo.jpg" alt=""></p>
<h2 id="三、思维导图"><a href="#三、思维导图" class="headerlink" title="三、思维导图"></a>三、思维导图</h2><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjrxs5kkfj30u00xb4lh.jpg" alt=""></p>
<h3 id="3-1、Utils"><a href="#3-1、Utils" class="headerlink" title="3.1、Utils"></a>3.1、Utils</h3><p>主要定义了一些常用工具类，宏定义（如，平台判断，信号量锁）、不同平台命名统一、位移枚举，错误枚举，加载菊花，图片加载动画等。</p>
<h3 id="3-2、Private"><a href="#3-2、Private" class="headerlink" title="3.2、Private"></a>3.2、Private</h3><p>私有工具类，文件、颜色，自定义NSOperation封装，封装NSBezierPath等</p>
<ul>
<li>封装了定时器SDDisplayLink及避免循环引用SDWeakProxy</li>
</ul>
<h3 id="3-3、Cache"><a href="#3-3、Cache" class="headerlink" title="3.3、Cache"></a>3.3、Cache</h3><p>图片缓存类，处理图片缓存，查找，删除，最大存储容量配置，过期数据处理。</p>
<ul>
<li><p>SDImageCacheConfig：缓存配置类，实现了NSCopying协议，图片默认磁盘缓存为一周</p>
</li>
<li><p>SDMemoryCache：内存缓存，继承NSCache实现，其内部用到了NSMapTable，默认shouldUseWeakMemoryCache为YES</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/// 定义属性</span><br><span class="line">@property (nonatomic, strong, nonnull) NSMapTable&lt;KeyType, ObjectType&gt; *weakCache; // strong-weak cache</span><br><span class="line"></span><br><span class="line">/// 创建</span><br><span class="line">self.weakCache = [[NSMapTable alloc] initWithKeyOptions:NSPointerFunctionsStrongMemory valueOptions:NSPointerFunctionsWeakMemory capacity:0];</span><br></pre></td></tr></table></figure>
</li>
<li><p>SDDiskCache：磁盘缓存，实现了存储、查询、删除等同步/异步操作，图片容量超容处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/// APP进入后台，对过期数据进行处理</span><br><span class="line">#if SD_UIKIT</span><br><span class="line">- (void)applicationDidEnterBackground:(NSNotification *)notification &#123;</span><br><span class="line">    if (!self.config.shouldRemoveExpiredDataWhenEnterBackground) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    Class UIApplicationClass = NSClassFromString(@&quot;UIApplication&quot;);</span><br><span class="line">    if(!UIApplicationClass || ![UIApplicationClass respondsToSelector:@selector(sharedApplication)]) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    UIApplication *application = [UIApplication performSelector:@selector(sharedApplication)];</span><br><span class="line">    __block UIBackgroundTaskIdentifier bgTask = [application beginBackgroundTaskWithExpirationHandler:^&#123;</span><br><span class="line">        // Clean up any unfinished task business by marking where you</span><br><span class="line">        // stopped or ending the task outright.</span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = UIBackgroundTaskInvalid;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    // Start the long-running task and return immediately.</span><br><span class="line">    [self deleteOldFilesWithCompletionBlock:^&#123;</span><br><span class="line">        [application endBackgroundTask:bgTask];</span><br><span class="line">        bgTask = UIBackgroundTaskInvalid;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>清理核心方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">- (void)removeExpiredData &#123;</span><br><span class="line">    NSURL *diskCacheURL = [NSURL fileURLWithPath:self.diskCachePath isDirectory:YES];</span><br><span class="line">    </span><br><span class="line">    // Compute content date key to be used for tests</span><br><span class="line">    NSURLResourceKey cacheContentDateKey = NSURLContentModificationDateKey;</span><br><span class="line">    switch (self.config.diskCacheExpireType) &#123;</span><br><span class="line">        case SDImageCacheConfigExpireTypeAccessDate:</span><br><span class="line">            cacheContentDateKey = NSURLContentAccessDateKey;</span><br><span class="line">            break;</span><br><span class="line">        case SDImageCacheConfigExpireTypeModificationDate:</span><br><span class="line">            cacheContentDateKey = NSURLContentModificationDateKey;</span><br><span class="line">            break;</span><br><span class="line">        case SDImageCacheConfigExpireTypeCreationDate:</span><br><span class="line">            cacheContentDateKey = NSURLCreationDateKey;</span><br><span class="line">            break;</span><br><span class="line">        case SDImageCacheConfigExpireTypeChangeDate:</span><br><span class="line">            cacheContentDateKey = NSURLAttributeModificationDateKey;</span><br><span class="line">            break;</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSArray&lt;NSString *&gt; *resourceKeys = @[NSURLIsDirectoryKey, cacheContentDateKey, NSURLTotalFileAllocatedSizeKey];</span><br><span class="line">    </span><br><span class="line">    // This enumerator prefetches useful properties for our cache files.</span><br><span class="line">    NSDirectoryEnumerator *fileEnumerator = [self.fileManager enumeratorAtURL:diskCacheURL</span><br><span class="line">                                               includingPropertiesForKeys:resourceKeys</span><br><span class="line">                                                                  options:NSDirectoryEnumerationSkipsHiddenFiles</span><br><span class="line">                                                             errorHandler:NULL];</span><br><span class="line">    </span><br><span class="line">    NSDate *expirationDate = (self.config.maxDiskAge &lt; 0) ? nil: [NSDate dateWithTimeIntervalSinceNow:-self.config.maxDiskAge];</span><br><span class="line">    NSMutableDictionary&lt;NSURL *, NSDictionary&lt;NSString *, id&gt; *&gt; *cacheFiles = [NSMutableDictionary dictionary];</span><br><span class="line">    NSUInteger currentCacheSize = 0;</span><br><span class="line">    </span><br><span class="line">    // Enumerate all of the files in the cache directory.  This loop has two purposes:</span><br><span class="line">    //</span><br><span class="line">    //  1. Removing files that are older than the expiration date.</span><br><span class="line">    //  2. Storing file attributes for the size-based cleanup pass.</span><br><span class="line">    NSMutableArray&lt;NSURL *&gt; *urlsToDelete = [[NSMutableArray alloc] init];</span><br><span class="line">    for (NSURL *fileURL in fileEnumerator) &#123;</span><br><span class="line">        NSError *error;</span><br><span class="line">        NSDictionary&lt;NSString *, id&gt; *resourceValues = [fileURL resourceValuesForKeys:resourceKeys error:&amp;error];</span><br><span class="line">        </span><br><span class="line">        // Skip directories and errors.</span><br><span class="line">        if (error || !resourceValues || [resourceValues[NSURLIsDirectoryKey] boolValue]) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // Remove files that are older than the expiration date;</span><br><span class="line">        NSDate *modifiedDate = resourceValues[cacheContentDateKey];</span><br><span class="line">        if (expirationDate &amp;&amp; [[modifiedDate laterDate:expirationDate] isEqualToDate:expirationDate]) &#123;</span><br><span class="line">            [urlsToDelete addObject:fileURL];</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // Store a reference to this file and account for its total size.</span><br><span class="line">        NSNumber *totalAllocatedSize = resourceValues[NSURLTotalFileAllocatedSizeKey];</span><br><span class="line">        currentCacheSize += totalAllocatedSize.unsignedIntegerValue;</span><br><span class="line">        cacheFiles[fileURL] = resourceValues;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    for (NSURL *fileURL in urlsToDelete) &#123;</span><br><span class="line">        [self.fileManager removeItemAtURL:fileURL error:nil];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // If our remaining disk cache exceeds a configured maximum size, perform a second</span><br><span class="line">    // size-based cleanup pass.  We delete the oldest files first.</span><br><span class="line">    NSUInteger maxDiskSize = self.config.maxDiskSize;</span><br><span class="line">    if (maxDiskSize &gt; 0 &amp;&amp; currentCacheSize &gt; maxDiskSize) &#123;</span><br><span class="line">        // Target half of our maximum cache size for this cleanup pass.</span><br><span class="line">        const NSUInteger desiredCacheSize = maxDiskSize / 2;</span><br><span class="line">        </span><br><span class="line">        // Sort the remaining cache files by their last modification time or last access time (oldest first).</span><br><span class="line">        NSArray&lt;NSURL *&gt; *sortedFiles = [cacheFiles keysSortedByValueWithOptions:NSSortConcurrent</span><br><span class="line">                                                                 usingComparator:^NSComparisonResult(id obj1, id obj2) &#123;</span><br><span class="line">                                                                     return [obj1[cacheContentDateKey] compare:obj2[cacheContentDateKey]];</span><br><span class="line">                                                                 &#125;];</span><br><span class="line">        </span><br><span class="line">        // Delete files until we fall below our desired cache size.</span><br><span class="line">        for (NSURL *fileURL in sortedFiles) &#123;</span><br><span class="line">            if ([self.fileManager removeItemAtURL:fileURL error:nil]) &#123;</span><br><span class="line">                NSDictionary&lt;NSString *, id&gt; *resourceValues = cacheFiles[fileURL];</span><br><span class="line">                NSNumber *totalAllocatedSize = resourceValues[NSURLTotalFileAllocatedSizeKey];</span><br><span class="line">                currentCacheSize -= totalAllocatedSize.unsignedIntegerValue;</span><br><span class="line">                </span><br><span class="line">                if (currentCacheSize &lt; desiredCacheSize) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>SDImageCachesManager：管理遵循SDImageCache协议的对象，同时自己也遵循SDImageCache协议，将相关操作派发的具体的处理类，如磁盘、内存缓存。</p>
</li>
</ul>
<h3 id="3-4、Prefetcher"><a href="#3-4、Prefetcher" class="headerlink" title="3.4、Prefetcher"></a>3.4、Prefetcher</h3><blockquote>
<p>Prefetch some URLs in the cache for future use. Images are downloaded in low priority.</p>
</blockquote>
<p>预取缓存中的一些url以备将来使用。以低优先级下载图像。</p>
<h3 id="3-5、Transformer"><a href="#3-5、Transformer" class="headerlink" title="3.5、Transformer"></a>3.5、Transformer</h3><blockquote>
<p>/**</p>
<p> A transformer protocol to transform the image load from cache or from download.</p>
<p> You can provide transformer to cache and manager (Through the <code>transformer</code> property or context option <code>SDWebImageContextImageTransformer</code>).</p>
<p> @note The transform process is called from a global queue in order to not to block the main queue.</p>
<p> */</p>
</blockquote>
<p>图片转化相关属性包装，现在提供了这几种<strong>SDImagePipelineTransformer</strong>，<strong>SDImageRoundCornerTransformer</strong>、<strong>SDImageResizingTransformer</strong>、<strong>SDImageCroppingTransformer</strong>、<strong>SDImageFlippingTransformer</strong>、<strong>SDImageRotationTransformer</strong>、<strong>SDImageTintTransformer</strong>、<strong>SDImageBlurTransformer</strong>、<strong>SDImageFilterTransformer</strong>，见名知意这些Transformer的用途，其实现类<strong>UIImage+Transform</strong> Category中。</p>
<h3 id="3-6、Downloader"><a href="#3-6、Downloader" class="headerlink" title="3.6、Downloader"></a>3.6、Downloader</h3><p>图片下载处理相关类，下载结果通过Block回调。提供了根据URL下载图片，可控制暂停、取消，最大下载并发数量，默认是6个，下载一些状态获取。</p>
<p><strong>SDWebImageDownloaderConfig</strong>：下载相关配置，如最大并发数量，请求超时设置，队列执行顺序，证书设置等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> The class contains all the config for image downloader</span><br><span class="line"> @note This class conform to NSCopying, make sure to add the property in `copyWithZone:` as well.</span><br><span class="line"> */</span><br><span class="line">@interface SDWebImageDownloaderConfig : NSObject &lt;NSCopying&gt;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Gets the default downloader config used for shared instance or initialization when it does not provide any downloader config. Such as `SDWebImageDownloader.sharedDownloader`.</span><br><span class="line"> @note You can modify the property on default downloader config, which can be used for later created downloader instance. The already created downloader instance does not get affected.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, class, readonly, nonnull) SDWebImageDownloaderConfig *defaultDownloaderConfig;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The maximum number of concurrent downloads.</span><br><span class="line"> * Defaults to 6.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, assign) NSInteger maxConcurrentDownloads;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The timeout value (in seconds) for each download operation.</span><br><span class="line"> * Defaults to 15.0.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, assign) NSTimeInterval downloadTimeout;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The minimum interval about progress percent during network downloading. Which means the next progress callback and current progress callback&apos;s progress percent difference should be larger or equal to this value. However, the final finish download progress callback does not get effected.</span><br><span class="line"> * The value should be 0.0-1.0.</span><br><span class="line"> * @note If you&apos;re using progressive decoding feature, this will also effect the image refresh rate.</span><br><span class="line"> * @note This value may enhance the performance if you don&apos;t want progress callback too frequently.</span><br><span class="line"> * Defaults to 0, which means each time we receive the new data from URLSession, we callback the progressBlock immediately.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, assign) double minimumProgressInterval;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * The custom session configuration in use by NSURLSession. If you don&apos;t provide one, we will use `defaultSessionConfiguration` instead.</span><br><span class="line"> * Defatuls to nil.</span><br><span class="line"> * @note This property does not support dynamic changes, means it&apos;s immutable after the downloader instance initialized.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong, nullable) NSURLSessionConfiguration *sessionConfiguration;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Gets/Sets a subclass of `SDWebImageDownloaderOperation` as the default</span><br><span class="line"> * `NSOperation` to be used each time SDWebImage constructs a request</span><br><span class="line"> * operation to download an image.</span><br><span class="line"> * Defaults to nil.</span><br><span class="line"> * @note Passing `NSOperation&lt;SDWebImageDownloaderOperation&gt;` to set as default. Passing `nil` will revert to `SDWebImageDownloaderOperation`.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, assign, nullable) Class operationClass;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Changes download operations execution order.</span><br><span class="line"> * Defaults to `SDWebImageDownloaderFIFOExecutionOrder`.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, assign) SDWebImageDownloaderExecutionOrder executionOrder;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Set the default URL credential to be set for request operations.</span><br><span class="line"> * Defaults to nil.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy, nullable) NSURLCredential *urlCredential;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Set username using for HTTP Basic authentication.</span><br><span class="line"> * Defaults to nil.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy, nullable) NSString *username;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Set password using for HTTP Basic authentication.</span><br><span class="line"> * Defautls to nil.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy, nullable) NSString *password;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>SDWebImageDownloaderRequestModifier</strong>：封装NSMutableURLRequest相关设置，可通过提供Block配置。</li>
<li><strong>SDWebImageDownloaderResponseModifier</strong>：请求NSHTTPURLResponse配置，可通过提供Block配置。</li>
<li><strong>SDWebImageDownloaderDecryptor</strong>：图片二进制加密处理，可通过提供Block配置。默认Base64。</li>
</ul>
<p><strong>SDImageLoader</strong>：定义了图片下载方法协议<strong>SDImageLoader</strong>，图片解码方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> This is the built-in decoding process for image download from network or local file.</span><br><span class="line"> @note If you want to implement your custom loader with `requestImageWithURL:options:context:progress:completed:` API, but also want to keep compatible with SDWebImage&apos;s behavior, you&apos;d better use this to produce image.</span><br><span class="line"></span><br><span class="line"> @param imageData The image data from the network. Should not be nil</span><br><span class="line"> @param imageURL The image URL from the input. Should not be nil</span><br><span class="line"> @param options The options arg from the input</span><br><span class="line"> @param context The context arg from the input</span><br><span class="line"> @return The decoded image for current image data load from the network</span><br><span class="line"> */</span><br><span class="line">FOUNDATION_EXPORT UIImage * _Nullable SDImageLoaderDecodeImageData(NSData * _Nonnull imageData, NSURL * _Nonnull imageURL, SDWebImageOptions options, SDWebImageContext * _Nullable context);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> This is the built-in decoding process for image progressive download from network. It&apos;s used when `SDWebImageProgressiveLoad` option is set. (It&apos;s not required when your loader does not support progressive image loading)</span><br><span class="line"> @note If you want to implement your custom loader with `requestImageWithURL:options:context:progress:completed:` API, but also want to keep compatible with SDWebImage&apos;s behavior, you&apos;d better use this to produce image.</span><br><span class="line"></span><br><span class="line"> @param imageData The image data from the network so far. Should not be nil</span><br><span class="line"> @param imageURL The image URL from the input. Should not be nil</span><br><span class="line"> @param finished Pass NO to specify the download process has not finished. Pass YES when all image data has finished.</span><br><span class="line"> @param operation The loader operation associated with current progressive download. Why to provide this is because progressive decoding need to store the partial decoded context for each operation to avoid conflict. You should provide the operation from `loadImageWithURL:` method return value.</span><br><span class="line"> @param options The options arg from the input</span><br><span class="line"> @param context The context arg from the input</span><br><span class="line"> @return The decoded progressive image for current image data load from the network</span><br><span class="line"> */</span><br><span class="line">FOUNDATION_EXPORT UIImage * _Nullable SDImageLoaderDecodeProgressiveImageData(NSData * _Nonnull imageData, NSURL * _Nonnull imageURL, BOOL finished,  id&lt;SDWebImageOperation&gt; _Nonnull operation, SDWebImageOptions options, SDWebImageContext * _Nullable context);</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>SDWebImageDownloaderOperation</strong>: 自定义NSOperation子类，封装了图片下载任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">/// 图片下载任务方法</span><br><span class="line">- (void)start &#123;</span><br><span class="line">    @synchronized (self) &#123;</span><br><span class="line">        if (self.isCancelled) &#123;</span><br><span class="line">            self.finished = YES;</span><br><span class="line">            // Operation cancelled by user before sending the request</span><br><span class="line">            [self callCompletionBlocksWithError:[NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorCancelled userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Operation cancelled by user before sending the request&quot;&#125;]];</span><br><span class="line">            [self reset];</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">#if SD_UIKIT</span><br><span class="line">        Class UIApplicationClass = NSClassFromString(@&quot;UIApplication&quot;);</span><br><span class="line">        BOOL hasApplication = UIApplicationClass &amp;&amp; [UIApplicationClass respondsToSelector:@selector(sharedApplication)];</span><br><span class="line">        if (hasApplication &amp;&amp; [self shouldContinueWhenAppEntersBackground]) &#123;</span><br><span class="line">            __weak typeof(self) wself = self;</span><br><span class="line">            UIApplication * app = [UIApplicationClass performSelector:@selector(sharedApplication)];</span><br><span class="line">            self.backgroundTaskId = [app beginBackgroundTaskWithExpirationHandler:^&#123;</span><br><span class="line">                [wself cancel];</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">        NSURLSession *session = self.unownedSession;</span><br><span class="line">        if (!session) &#123;</span><br><span class="line">            NSURLSessionConfiguration *sessionConfig = [NSURLSessionConfiguration defaultSessionConfiguration];</span><br><span class="line">            sessionConfig.timeoutIntervalForRequest = 15;</span><br><span class="line">            </span><br><span class="line">            /**</span><br><span class="line">             *  Create the session for this task</span><br><span class="line">             *  We send nil as delegate queue so that the session creates a serial operation queue for performing all delegate</span><br><span class="line">             *  method calls and completion handler calls.</span><br><span class="line">             */</span><br><span class="line">            session = [NSURLSession sessionWithConfiguration:sessionConfig</span><br><span class="line">                                                    delegate:self</span><br><span class="line">                                               delegateQueue:nil];</span><br><span class="line">            self.ownedSession = session;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        if (self.options &amp; SDWebImageDownloaderIgnoreCachedResponse) &#123;</span><br><span class="line">            // Grab the cached data for later check</span><br><span class="line">            NSURLCache *URLCache = session.configuration.URLCache;</span><br><span class="line">            if (!URLCache) &#123;</span><br><span class="line">                URLCache = [NSURLCache sharedURLCache];</span><br><span class="line">            &#125;</span><br><span class="line">            NSCachedURLResponse *cachedResponse;</span><br><span class="line">            // NSURLCache&apos;s `cachedResponseForRequest:` is not thread-safe, see https://developer.apple.com/documentation/foundation/nsurlcache#2317483</span><br><span class="line">            @synchronized (URLCache) &#123;</span><br><span class="line">                cachedResponse = [URLCache cachedResponseForRequest:self.request];</span><br><span class="line">            &#125;</span><br><span class="line">            if (cachedResponse) &#123;</span><br><span class="line">                self.cachedData = cachedResponse.data;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        self.dataTask = [session dataTaskWithRequest:self.request];</span><br><span class="line">        self.executing = YES;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (self.dataTask) &#123;</span><br><span class="line">        if (self.options &amp; SDWebImageDownloaderHighPriority) &#123;</span><br><span class="line">            self.dataTask.priority = NSURLSessionTaskPriorityHigh;</span><br><span class="line">            self.coderQueue.qualityOfService = NSQualityOfServiceUserInteractive;</span><br><span class="line">        &#125; else if (self.options &amp; SDWebImageDownloaderLowPriority) &#123;</span><br><span class="line">            self.dataTask.priority = NSURLSessionTaskPriorityLow;</span><br><span class="line">            self.coderQueue.qualityOfService = NSQualityOfServiceBackground;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            self.dataTask.priority = NSURLSessionTaskPriorityDefault;</span><br><span class="line">            self.coderQueue.qualityOfService = NSQualityOfServiceDefault;</span><br><span class="line">        &#125;</span><br><span class="line">        [self.dataTask resume];</span><br><span class="line">        for (SDWebImageDownloaderProgressBlock progressBlock in [self callbacksForKey:kProgressCallbackKey]) &#123;</span><br><span class="line">            progressBlock(0, NSURLResponseUnknownLength, self.request.URL);</span><br><span class="line">        &#125;</span><br><span class="line">        __block typeof(self) strongSelf = self;</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [[NSNotificationCenter defaultCenter] postNotificationName:SDWebImageDownloadStartNotification object:strongSelf];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [self callCompletionBlocksWithError:[NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorInvalidDownloadOperation userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Task can&apos;t be initialized&quot;&#125;]];</span><br><span class="line">        [self done];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p><strong>SDWebImageDownloader</strong>：图片下载类，遵循了<strong>SDImageLoader</strong>，内部持有<strong>SDWebImageDownloaderConfig、</strong>SDWebImageDownloaderResponseModifier<strong>、</strong>SDWebImageDownloaderRequestModifier**等实例类。图片下载核心方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">/// 开始一个图片下载任务</span><br><span class="line">- (nullable SDWebImageDownloadToken *)downloadImageWithURL:(nullable NSURL *)url</span><br><span class="line">                                                   options:(SDWebImageDownloaderOptions)options</span><br><span class="line">                                                   context:(nullable SDWebImageContext *)context</span><br><span class="line">                                                  progress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</span><br><span class="line">                                                 completed:(nullable SDWebImageDownloaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</span><br><span class="line">    if (url == nil) &#123;</span><br><span class="line">        if (completedBlock) &#123;</span><br><span class="line">            NSError *error = [NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorInvalidURL userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Image url is nil&quot;&#125;];</span><br><span class="line">            completedBlock(nil, nil, error, YES);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SD_LOCK(self.operationsLock);</span><br><span class="line">    id downloadOperationCancelToken;</span><br><span class="line">    NSOperation&lt;SDWebImageDownloaderOperation&gt; *operation = [self.URLOperations objectForKey:url];</span><br><span class="line">    // There is a case that the operation may be marked as finished or cancelled, but not been removed from `self.URLOperations`.</span><br><span class="line">    if (!operation || operation.isFinished || operation.isCancelled) &#123;</span><br><span class="line">        operation = [self createDownloaderOperationWithUrl:url options:options context:context];</span><br><span class="line">        if (!operation) &#123;</span><br><span class="line">            SD_UNLOCK(self.operationsLock);</span><br><span class="line">            if (completedBlock) &#123;</span><br><span class="line">                NSError *error = [NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorInvalidDownloadOperation userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Downloader operation is nil&quot;&#125;];</span><br><span class="line">                completedBlock(nil, nil, error, YES);</span><br><span class="line">            &#125;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        @weakify(self);</span><br><span class="line">        operation.completionBlock = ^&#123;</span><br><span class="line">            @strongify(self);</span><br><span class="line">            if (!self) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            SD_LOCK(self.operationsLock);</span><br><span class="line">            [self.URLOperations removeObjectForKey:url];</span><br><span class="line">            SD_UNLOCK(self.operationsLock);</span><br><span class="line">        &#125;;</span><br><span class="line">        self.URLOperations[url] = operation;</span><br><span class="line">        // Add the handlers before submitting to operation queue, avoid the race condition that operation finished before setting handlers.</span><br><span class="line">        downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</span><br><span class="line">        // Add operation to operation queue only after all configuration done according to Apple&apos;s doc.</span><br><span class="line">        // `addOperation:` does not synchronously execute the `operation.completionBlock` so this will not cause deadlock.</span><br><span class="line">        [self.downloadQueue addOperation:operation];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // When we reuse the download operation to attach more callbacks, there may be thread safe issue because the getter of callbacks may in another queue (decoding queue or delegate queue)</span><br><span class="line">        // So we lock the operation here, and in `SDWebImageDownloaderOperation`, we use `@synchonzied (self)`, to ensure the thread safe between these two classes.</span><br><span class="line">        @synchronized (operation) &#123;</span><br><span class="line">            downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</span><br><span class="line">        &#125;</span><br><span class="line">        if (!operation.isExecuting) &#123;</span><br><span class="line">            if (options &amp; SDWebImageDownloaderHighPriority) &#123;</span><br><span class="line">                operation.queuePriority = NSOperationQueuePriorityHigh;</span><br><span class="line">            &#125; else if (options &amp; SDWebImageDownloaderLowPriority) &#123;</span><br><span class="line">                operation.queuePriority = NSOperationQueuePriorityLow;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                operation.queuePriority = NSOperationQueuePriorityNormal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SD_UNLOCK(self.operationsLock);</span><br><span class="line">    </span><br><span class="line">    SDWebImageDownloadToken *token = [[SDWebImageDownloadToken alloc] initWithDownloadOperation:operation];</span><br><span class="line">    token.url = url;</span><br><span class="line">    token.request = operation.request;</span><br><span class="line">    token.downloadOperationCancelToken = downloadOperationCancelToken;</span><br><span class="line">    </span><br><span class="line">    return token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>SDImageLoadersManager</strong>：遵循<strong>SDImageLoader</strong>协议，管理遵循了SDImageLoader协议的数组，主要代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - SDImageLoader</span><br><span class="line"></span><br><span class="line">- (BOOL)canRequestImageForURL:(nullable NSURL *)url &#123;</span><br><span class="line">    NSArray&lt;id&lt;SDImageLoader&gt;&gt; *loaders = self.loaders;</span><br><span class="line">    for (id&lt;SDImageLoader&gt; loader in loaders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([loader canRequestImageForURL:url]) &#123;</span><br><span class="line">            return YES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id&lt;SDWebImageOperation&gt;)requestImageWithURL:(NSURL *)url options:(SDWebImageOptions)options context:(SDWebImageContext *)context progress:(SDImageLoaderProgressBlock)progressBlock completed:(SDImageLoaderCompletedBlock)completedBlock &#123;</span><br><span class="line">    if (!url) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    NSArray&lt;id&lt;SDImageLoader&gt;&gt; *loaders = self.loaders;</span><br><span class="line">    for (id&lt;SDImageLoader&gt; loader in loaders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([loader canRequestImageForURL:url]) &#123;</span><br><span class="line">            return [loader requestImageWithURL:url options:options context:context progress:progressBlock completed:completedBlock];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)shouldBlockFailedURLWithURL:(NSURL *)url error:(NSError *)error &#123;</span><br><span class="line">    NSArray&lt;id&lt;SDImageLoader&gt;&gt; *loaders = self.loaders;</span><br><span class="line">    for (id&lt;SDImageLoader&gt; loader in loaders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([loader canRequestImageForURL:url]) &#123;</span><br><span class="line">            return [loader shouldBlockFailedURLWithURL:url error:error];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-5、Decoder"><a href="#3-5、Decoder" class="headerlink" title="3.5、Decoder"></a>3.5、Decoder</h3><p>图片编/解码。支持的图片格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> You can use switch case like normal enum. It&apos;s also recommended to add a default case. You should not assume anything about the raw value.</span><br><span class="line"> For custom coder plugin, it can also extern the enum for supported format. See `SDImageCoder` for more detailed information.</span><br><span class="line"> */</span><br><span class="line">typedef NSInteger SDImageFormat NS_TYPED_EXTENSIBLE_ENUM;</span><br><span class="line">static const SDImageFormat SDImageFormatUndefined = -1;</span><br><span class="line">static const SDImageFormat SDImageFormatJPEG      = 0;</span><br><span class="line">static const SDImageFormat SDImageFormatPNG       = 1;</span><br><span class="line">static const SDImageFormat SDImageFormatGIF       = 2;</span><br><span class="line">static const SDImageFormat SDImageFormatTIFF      = 3;</span><br><span class="line">static const SDImageFormat SDImageFormatWebP      = 4; /// SDWebImage默认不支持</span><br><span class="line">static const SDImageFormat SDImageFormatHEIC      = 5;</span><br><span class="line">static const SDImageFormat SDImageFormatHEIF      = 6;</span><br><span class="line">static const SDImageFormat SDImageFormatPDF       = 7;</span><br><span class="line">static const SDImageFormat SDImageFormatSVG       = 8;</span><br></pre></td></tr></table></figure>
<p>对于特殊格式的图片，SDWebImage创建了一个对应的编解码子类，遵循了<strong>SDImageIOAnimatedCoder</strong>，<strong>SDImageIOAnimatedCoder</strong>又遵循了<strong>&lt;SDProgressiveImageCoder, SDAnimatedImageCoder&gt;</strong>协议。这部分内容还是相对来说枯燥复杂的。</p>
<ul>
<li><strong>SDImageCoder</strong>：定义了主要编解码方法，同时也定义了<strong>SDProgressiveImageCoder</strong>、<strong>SDAnimatedImageCoder</strong>、<strong>SDAnimatedImageProvider</strong>等协议</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - Coder</span><br><span class="line">/**</span><br><span class="line"> This is the image coder protocol to provide custom image decoding/encoding.</span><br><span class="line"> These methods are all required to implement.</span><br><span class="line"> @note Pay attention that these methods are not called from main queue.</span><br><span class="line"> */</span><br><span class="line">@protocol SDImageCoder &lt;NSObject&gt;</span><br><span class="line"></span><br><span class="line">@required</span><br><span class="line">#pragma mark - Decoding</span><br><span class="line">/**</span><br><span class="line"> Returns YES if this coder can decode some data. Otherwise, the data should be passed to another coder.</span><br><span class="line"> </span><br><span class="line"> @param data The image data so we can look at it</span><br><span class="line"> @return YES if this coder can decode the data, NO otherwise</span><br><span class="line"> */</span><br><span class="line">- (BOOL)canDecodeFromData:(nullable NSData *)data;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Decode the image data to image.</span><br><span class="line"> @note This protocol may supports decode animated image frames. You can use `+[SDImageCoderHelper animatedImageWithFrames:]` to produce an animated image with frames.</span><br><span class="line"></span><br><span class="line"> @param data The image data to be decoded</span><br><span class="line"> @param options A dictionary containing any decoding options. Pass @&#123;SDImageCoderDecodeScaleFactor: @(1.0)&#125; to specify scale factor for image. Pass @&#123;SDImageCoderDecodeFirstFrameOnly: @(YES)&#125; to decode the first frame only.</span><br><span class="line"> @return The decoded image from data</span><br><span class="line"> */</span><br><span class="line">- (nullable UIImage *)decodedImageWithData:(nullable NSData *)data</span><br><span class="line">                                   options:(nullable SDImageCoderOptions *)options;</span><br><span class="line"></span><br><span class="line">#pragma mark - Encoding</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Returns YES if this coder can encode some image. Otherwise, it should be passed to another coder.</span><br><span class="line"> For custom coder which introduce new image format, you&apos;d better define a new `SDImageFormat` using like this. If you&apos;re creating public coder plugin for new image format, also update `https://github.com/rs/SDWebImage/wiki/Coder-Plugin-List` to avoid same value been defined twice.</span><br><span class="line"> * @code</span><br><span class="line"> static const SDImageFormat SDImageFormatHEIF = 10;</span><br><span class="line"> * @endcode</span><br><span class="line"> </span><br><span class="line"> @param format The image format</span><br><span class="line"> @return YES if this coder can encode the image, NO otherwise</span><br><span class="line"> */</span><br><span class="line">- (BOOL)canEncodeToFormat:(SDImageFormat)format NS_SWIFT_NAME(canEncode(to:));</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Encode the image to image data.</span><br><span class="line"> @note This protocol may supports encode animated image frames. You can use `+[SDImageCoderHelper framesFromAnimatedImage:]` to assemble an animated image with frames.</span><br><span class="line"></span><br><span class="line"> @param image The image to be encoded</span><br><span class="line"> @param format The image format to encode, you should note `SDImageFormatUndefined` format is also  possible</span><br><span class="line"> @param options A dictionary containing any encoding options. Pass @&#123;SDImageCoderEncodeCompressionQuality: @(1)&#125; to specify compression quality.</span><br><span class="line"> @return The encoded image data</span><br><span class="line"> */</span><br><span class="line">- (nullable NSData *)encodedDataWithImage:(nullable UIImage *)image</span><br><span class="line">                                   format:(SDImageFormat)format</span><br><span class="line">                                  options:(nullable SDImageCoderOptions *)options;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>SDImageCodersManager</strong>：管理了各种图片格式编/解码类，同时遵循了SDImageCoder协议，核心代码如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - SDImageCoder</span><br><span class="line">- (BOOL)canDecodeFromData:(NSData *)data &#123;</span><br><span class="line">    NSArray&lt;id&lt;SDImageCoder&gt;&gt; *coders = self.coders;</span><br><span class="line">    for (id&lt;SDImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([coder canDecodeFromData:data]) &#123;</span><br><span class="line">            return YES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)canEncodeToFormat:(SDImageFormat)format &#123;</span><br><span class="line">    NSArray&lt;id&lt;SDImageCoder&gt;&gt; *coders = self.coders;</span><br><span class="line">    for (id&lt;SDImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([coder canEncodeToFormat:format]) &#123;</span><br><span class="line">            return YES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (UIImage *)decodedImageWithData:(NSData *)data options:(nullable SDImageCoderOptions *)options &#123;</span><br><span class="line">    if (!data) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    UIImage *image;</span><br><span class="line">    NSArray&lt;id&lt;SDImageCoder&gt;&gt; *coders = self.coders;</span><br><span class="line">    for (id&lt;SDImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([coder canDecodeFromData:data]) &#123;</span><br><span class="line">            image = [coder decodedImageWithData:data options:options];</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return image;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSData *)encodedDataWithImage:(UIImage *)image format:(SDImageFormat)format options:(nullable SDImageCoderOptions *)options &#123;</span><br><span class="line">    if (!image) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    NSArray&lt;id&lt;SDImageCoder&gt;&gt; *coders = self.coders;</span><br><span class="line">    for (id&lt;SDImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</span><br><span class="line">        if ([coder canEncodeToFormat:format]) &#123;</span><br><span class="line">            return [coder encodedDataWithImage:image format:format options:options];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="3-7、Manager"><a href="#3-7、Manager" class="headerlink" title="3.7、Manager"></a>3.7、Manager</h3><p>UIKit相关UI控件分类API调用上游类， 管理图片缓存、下载、编/解码、转换等操作。</p>
<ul>
<li><strong>SDWebImageManager</strong>：SDWebImage核心类。提供了各种操作实例代码。</li>
</ul>
<p>初始化方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Allows to specify instance of cache and image loader used with image manager.</span><br><span class="line"> * @return new instance of `SDWebImageManager` with specified cache and loader.</span><br><span class="line"> */</span><br><span class="line">- (nonnull instancetype)initWithCache:(nonnull id&lt;SDImageCache&gt;)cache loader:(nonnull id&lt;SDImageLoader&gt;)loader NS_DESIGNATED_INITIALIZER;</span><br></pre></td></tr></table></figure>
<p>下载图片方法定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Downloads the image at the given URL if not present in cache or return the cached version otherwise.</span><br><span class="line"> *</span><br><span class="line"> * @param url            The URL to the image</span><br><span class="line"> * @param options        A mask to specify options to use for this request</span><br><span class="line"> * @param context        A context contains different options to perform specify changes or processes, see `SDWebImageContextOption`. This hold the extra objects which `options` enum can not hold.</span><br><span class="line"> * @param progressBlock  A block called while image is downloading</span><br><span class="line"> *                       @note the progress block is executed on a background queue</span><br><span class="line"> * @param completedBlock A block called when operation has been completed.</span><br><span class="line"> *</span><br><span class="line"> * @return Returns an instance of SDWebImageCombinedOperation, which you can cancel the loading process.</span><br><span class="line"> */</span><br><span class="line">- (nullable SDWebImageCombinedOperation *)loadImageWithURL:(nullable NSURL *)url</span><br><span class="line">                                                   options:(SDWebImageOptions)options</span><br><span class="line">                                                   context:(nullable SDWebImageContext *)context</span><br><span class="line">                                                  progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                                                 completed:(nonnull SDInternalCompletionBlock)completedBlock;</span><br></pre></td></tr></table></figure>
<p>下载图片方法实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br></pre></td><td class="code"><pre><span class="line">/// 实现</span><br><span class="line">- (SDWebImageCombinedOperation *)loadImageWithURL:(nullable NSURL *)url</span><br><span class="line">                                          options:(SDWebImageOptions)options</span><br><span class="line">                                          context:(nullable SDWebImageContext *)context</span><br><span class="line">                                         progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                                        completed:(nonnull SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    // Invoking this method without a completedBlock is pointless</span><br><span class="line">    NSAssert(completedBlock != nil, @&quot;If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead&quot;);</span><br><span class="line"></span><br><span class="line">    // Very common mistake is to send the URL using NSString object instead of NSURL. For some strange reason, Xcode won&apos;t</span><br><span class="line">    // throw any warning for this type mismatch. Here we failsafe this error by allowing URLs to be passed as NSString.</span><br><span class="line">    if ([url isKindOfClass:NSString.class]) &#123;</span><br><span class="line">        url = [NSURL URLWithString:(NSString *)url];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Prevents app crashing on argument type error like sending NSNull instead of NSURL</span><br><span class="line">    if (![url isKindOfClass:NSURL.class]) &#123;</span><br><span class="line">        url = nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</span><br><span class="line">    operation.manager = self;</span><br><span class="line"></span><br><span class="line">    BOOL isFailedUrl = NO;</span><br><span class="line">    if (url) &#123;</span><br><span class="line">        SD_LOCK(self.failedURLsLock);</span><br><span class="line">        isFailedUrl = [self.failedURLs containsObject:url];</span><br><span class="line">        SD_UNLOCK(self.failedURLsLock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (url.absoluteString.length == 0 || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</span><br><span class="line">        NSString *description = isFailedUrl ? @&quot;Image url is blacklisted&quot; : @&quot;Image url is nil&quot;;</span><br><span class="line">        NSInteger code = isFailedUrl ? SDWebImageErrorBlackListed : SDWebImageErrorInvalidURL;</span><br><span class="line">        [self callCompletionBlockForOperation:operation completion:completedBlock error:[NSError errorWithDomain:SDWebImageErrorDomain code:code userInfo:@&#123;NSLocalizedDescriptionKey : description&#125;] url:url];</span><br><span class="line">        return operation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SD_LOCK(self.runningOperationsLock);</span><br><span class="line">    [self.runningOperations addObject:operation];</span><br><span class="line">    SD_UNLOCK(self.runningOperationsLock);</span><br><span class="line">    </span><br><span class="line">    // Preprocess the options and context arg to decide the final the result for manager</span><br><span class="line">    SDWebImageOptionsResult *result = [self processedResultForURL:url options:options context:context];</span><br><span class="line">    </span><br><span class="line">    // Start the entry to load image from cache</span><br><span class="line">    [self callCacheProcessForOperation:operation url:url options:result.options context:result.context progress:progressBlock completed:completedBlock];</span><br><span class="line"></span><br><span class="line">    return operation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#pragma mark - Private</span><br><span class="line"></span><br><span class="line">// Query normal cache process</span><br><span class="line">- (void)callCacheProcessForOperation:(nonnull SDWebImageCombinedOperation *)operation</span><br><span class="line">                                 url:(nonnull NSURL *)url</span><br><span class="line">                             options:(SDWebImageOptions)options</span><br><span class="line">                             context:(nullable SDWebImageContext *)context</span><br><span class="line">                            progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                           completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    // Grab the image cache to use</span><br><span class="line">    id&lt;SDImageCache&gt; imageCache;</span><br><span class="line">    if ([context[SDWebImageContextImageCache] conformsToProtocol:@protocol(SDImageCache)]) &#123;</span><br><span class="line">        imageCache = context[SDWebImageContextImageCache];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        imageCache = self.imageCache;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Get the query cache type</span><br><span class="line">    SDImageCacheType queryCacheType = SDImageCacheTypeAll;</span><br><span class="line">    if (context[SDWebImageContextQueryCacheType]) &#123;</span><br><span class="line">        queryCacheType = [context[SDWebImageContextQueryCacheType] integerValue];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Check whether we should query cache</span><br><span class="line">    BOOL shouldQueryCache = !SD_OPTIONS_CONTAINS(options, SDWebImageFromLoaderOnly);</span><br><span class="line">    if (shouldQueryCache) &#123;</span><br><span class="line">        NSString *key = [self cacheKeyForURL:url context:context];</span><br><span class="line">        @weakify(operation);</span><br><span class="line">        operation.cacheOperation = [imageCache queryImageForKey:key options:options context:context cacheType:queryCacheType completion:^(UIImage * _Nullable cachedImage, NSData * _Nullable cachedData, SDImageCacheType cacheType) &#123;</span><br><span class="line">            @strongify(operation);</span><br><span class="line">            if (!operation || operation.isCancelled) &#123;</span><br><span class="line">                // Image combined operation cancelled by user</span><br><span class="line">                [self callCompletionBlockForOperation:operation completion:completedBlock error:[NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorCancelled userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Operation cancelled by user during querying the cache&quot;&#125;] url:url];</span><br><span class="line">                [self safelyRemoveOperationFromRunning:operation];</span><br><span class="line">                return;</span><br><span class="line">            &#125; else if (context[SDWebImageContextImageTransformer] &amp;&amp; !cachedImage) &#123;</span><br><span class="line">                // Have a chance to quary original cache instead of downloading</span><br><span class="line">                [self callOriginalCacheProcessForOperation:operation url:url options:options context:context progress:progressBlock completed:completedBlock];</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Continue download process</span><br><span class="line">            [self callDownloadProcessForOperation:operation url:url options:options context:context cachedImage:cachedImage cachedData:cachedData cacheType:cacheType progress:progressBlock completed:completedBlock];</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Continue download process</span><br><span class="line">        [self callDownloadProcessForOperation:operation url:url options:options context:context cachedImage:nil cachedData:nil cacheType:SDImageCacheTypeNone progress:progressBlock completed:completedBlock];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Query original cache process</span><br><span class="line">- (void)callOriginalCacheProcessForOperation:(nonnull SDWebImageCombinedOperation *)operation</span><br><span class="line">                                         url:(nonnull NSURL *)url</span><br><span class="line">                                     options:(SDWebImageOptions)options</span><br><span class="line">                                     context:(nullable SDWebImageContext *)context</span><br><span class="line">                                    progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                                   completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    // Grab the image cache to use</span><br><span class="line">    id&lt;SDImageCache&gt; imageCache;</span><br><span class="line">    if ([context[SDWebImageContextImageCache] conformsToProtocol:@protocol(SDImageCache)]) &#123;</span><br><span class="line">        imageCache = context[SDWebImageContextImageCache];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        imageCache = self.imageCache;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Get the original query cache type</span><br><span class="line">    SDImageCacheType originalQueryCacheType = SDImageCacheTypeNone;</span><br><span class="line">    if (context[SDWebImageContextOriginalQueryCacheType]) &#123;</span><br><span class="line">        originalQueryCacheType = [context[SDWebImageContextOriginalQueryCacheType] integerValue];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Check whether we should query original cache</span><br><span class="line">    BOOL shouldQueryOriginalCache = (originalQueryCacheType != SDImageCacheTypeNone);</span><br><span class="line">    if (shouldQueryOriginalCache) &#123;</span><br><span class="line">        // Change originContext to mutable</span><br><span class="line">        SDWebImageMutableContext * __block originContext;</span><br><span class="line">        if (context) &#123;</span><br><span class="line">            originContext = [context mutableCopy];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            originContext = [NSMutableDictionary dictionary];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // Disable transformer for cache key generation</span><br><span class="line">        id&lt;SDImageTransformer&gt; transformer = originContext[SDWebImageContextImageTransformer];</span><br><span class="line">        originContext[SDWebImageContextImageTransformer] = [NSNull null];</span><br><span class="line">        </span><br><span class="line">        NSString *key = [self cacheKeyForURL:url context:originContext];</span><br><span class="line">        @weakify(operation);</span><br><span class="line">        operation.cacheOperation = [imageCache queryImageForKey:key options:options context:context cacheType:originalQueryCacheType completion:^(UIImage * _Nullable cachedImage, NSData * _Nullable cachedData, SDImageCacheType cacheType) &#123;</span><br><span class="line">            @strongify(operation);</span><br><span class="line">            if (!operation || operation.isCancelled) &#123;</span><br><span class="line">                // Image combined operation cancelled by user</span><br><span class="line">                [self callCompletionBlockForOperation:operation completion:completedBlock error:[NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorCancelled userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Operation cancelled by user during querying the cache&quot;&#125;] url:url];</span><br><span class="line">                [self safelyRemoveOperationFromRunning:operation];</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Add original transformer</span><br><span class="line">            if (transformer) &#123;</span><br><span class="line">                originContext[SDWebImageContextImageTransformer] = transformer;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Use the store cache process instead of downloading, and ignore .refreshCached option for now</span><br><span class="line">            [self callStoreCacheProcessForOperation:operation url:url options:options context:context downloadedImage:cachedImage downloadedData:cachedData finished:YES progress:progressBlock completed:completedBlock];</span><br><span class="line">            </span><br><span class="line">            [self safelyRemoveOperationFromRunning:operation];</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Continue download process</span><br><span class="line">        [self callDownloadProcessForOperation:operation url:url options:options context:context cachedImage:nil cachedData:nil cacheType:originalQueryCacheType progress:progressBlock completed:completedBlock];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Download process</span><br><span class="line">- (void)callDownloadProcessForOperation:(nonnull SDWebImageCombinedOperation *)operation</span><br><span class="line">                                    url:(nonnull NSURL *)url</span><br><span class="line">                                options:(SDWebImageOptions)options</span><br><span class="line">                                context:(SDWebImageContext *)context</span><br><span class="line">                            cachedImage:(nullable UIImage *)cachedImage</span><br><span class="line">                             cachedData:(nullable NSData *)cachedData</span><br><span class="line">                              cacheType:(SDImageCacheType)cacheType</span><br><span class="line">                               progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                              completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    // Grab the image loader to use</span><br><span class="line">    id&lt;SDImageLoader&gt; imageLoader;</span><br><span class="line">    if ([context[SDWebImageContextImageLoader] conformsToProtocol:@protocol(SDImageLoader)]) &#123;</span><br><span class="line">        imageLoader = context[SDWebImageContextImageLoader];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        imageLoader = self.imageLoader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Check whether we should download image from network</span><br><span class="line">    BOOL shouldDownload = !SD_OPTIONS_CONTAINS(options, SDWebImageFromCacheOnly);</span><br><span class="line">    shouldDownload &amp;= (!cachedImage || options &amp; SDWebImageRefreshCached);</span><br><span class="line">    shouldDownload &amp;= (![self.delegate respondsToSelector:@selector(imageManager:shouldDownloadImageForURL:)] || [self.delegate imageManager:self shouldDownloadImageForURL:url]);</span><br><span class="line">    shouldDownload &amp;= [imageLoader canRequestImageForURL:url];</span><br><span class="line">    if (shouldDownload) &#123;</span><br><span class="line">        if (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</span><br><span class="line">            // If image was found in the cache but SDWebImageRefreshCached is provided, notify about the cached image</span><br><span class="line">            // AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</span><br><span class="line">            [self callCompletionBlockForOperation:operation completion:completedBlock image:cachedImage data:cachedData error:nil cacheType:cacheType finished:YES url:url];</span><br><span class="line">            // Pass the cached image to the image loader. The image loader should check whether the remote image is equal to the cached image.</span><br><span class="line">            SDWebImageMutableContext *mutableContext;</span><br><span class="line">            if (context) &#123;</span><br><span class="line">                mutableContext = [context mutableCopy];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mutableContext = [NSMutableDictionary dictionary];</span><br><span class="line">            &#125;</span><br><span class="line">            mutableContext[SDWebImageContextLoaderCachedImage] = cachedImage;</span><br><span class="line">            context = [mutableContext copy];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        @weakify(operation);</span><br><span class="line">        operation.loaderOperation = [imageLoader requestImageWithURL:url options:options context:context progress:progressBlock completed:^(UIImage *downloadedImage, NSData *downloadedData, NSError *error, BOOL finished) &#123;</span><br><span class="line">            @strongify(operation);</span><br><span class="line">            if (!operation || operation.isCancelled) &#123;</span><br><span class="line">                // Image combined operation cancelled by user</span><br><span class="line">                [self callCompletionBlockForOperation:operation completion:completedBlock error:[NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorCancelled userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Operation cancelled by user during sending the request&quot;&#125;] url:url];</span><br><span class="line">            &#125; else if (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached &amp;&amp; [error.domain isEqualToString:SDWebImageErrorDomain] &amp;&amp; error.code == SDWebImageErrorCacheNotModified) &#123;</span><br><span class="line">                // Image refresh hit the NSURLCache cache, do not call the completion block</span><br><span class="line">            &#125; else if ([error.domain isEqualToString:SDWebImageErrorDomain] &amp;&amp; error.code == SDWebImageErrorCancelled) &#123;</span><br><span class="line">                // Download operation cancelled by user before sending the request, don&apos;t block failed URL</span><br><span class="line">                [self callCompletionBlockForOperation:operation completion:completedBlock error:error url:url];</span><br><span class="line">            &#125; else if (error) &#123;</span><br><span class="line">                [self callCompletionBlockForOperation:operation completion:completedBlock error:error url:url];</span><br><span class="line">                BOOL shouldBlockFailedURL = [self shouldBlockFailedURLWithURL:url error:error options:options context:context];</span><br><span class="line">                </span><br><span class="line">                if (shouldBlockFailedURL) &#123;</span><br><span class="line">                    SD_LOCK(self.failedURLsLock);</span><br><span class="line">                    [self.failedURLs addObject:url];</span><br><span class="line">                    SD_UNLOCK(self.failedURLsLock);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if ((options &amp; SDWebImageRetryFailed)) &#123;</span><br><span class="line">                    SD_LOCK(self.failedURLsLock);</span><br><span class="line">                    [self.failedURLs removeObject:url];</span><br><span class="line">                    SD_UNLOCK(self.failedURLsLock);</span><br><span class="line">                &#125;</span><br><span class="line">                // Continue store cache process</span><br><span class="line">                [self callStoreCacheProcessForOperation:operation url:url options:options context:context downloadedImage:downloadedImage downloadedData:downloadedData finished:finished progress:progressBlock completed:completedBlock];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (finished) &#123;</span><br><span class="line">                [self safelyRemoveOperationFromRunning:operation];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; else if (cachedImage) &#123;</span><br><span class="line">        [self callCompletionBlockForOperation:operation completion:completedBlock image:cachedImage data:cachedData error:nil cacheType:cacheType finished:YES url:url];</span><br><span class="line">        [self safelyRemoveOperationFromRunning:operation];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Image not in cache and download disallowed by delegate</span><br><span class="line">        [self callCompletionBlockForOperation:operation completion:completedBlock image:nil data:nil error:nil cacheType:SDImageCacheTypeNone finished:YES url:url];</span><br><span class="line">        [self safelyRemoveOperationFromRunning:operation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Store cache process</span><br><span class="line">- (void)callStoreCacheProcessForOperation:(nonnull SDWebImageCombinedOperation *)operation</span><br><span class="line">                                      url:(nonnull NSURL *)url</span><br><span class="line">                                  options:(SDWebImageOptions)options</span><br><span class="line">                                  context:(SDWebImageContext *)context</span><br><span class="line">                          downloadedImage:(nullable UIImage *)downloadedImage</span><br><span class="line">                           downloadedData:(nullable NSData *)downloadedData</span><br><span class="line">                                 finished:(BOOL)finished</span><br><span class="line">                                 progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                                completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    // the target image store cache type</span><br><span class="line">    SDImageCacheType storeCacheType = SDImageCacheTypeAll;</span><br><span class="line">    if (context[SDWebImageContextStoreCacheType]) &#123;</span><br><span class="line">        storeCacheType = [context[SDWebImageContextStoreCacheType] integerValue];</span><br><span class="line">    &#125;</span><br><span class="line">    // the original store image cache type</span><br><span class="line">    SDImageCacheType originalStoreCacheType = SDImageCacheTypeNone;</span><br><span class="line">    if (context[SDWebImageContextOriginalStoreCacheType]) &#123;</span><br><span class="line">        originalStoreCacheType = [context[SDWebImageContextOriginalStoreCacheType] integerValue];</span><br><span class="line">    &#125;</span><br><span class="line">    // origin cache key</span><br><span class="line">    SDWebImageMutableContext *originContext = [context mutableCopy];</span><br><span class="line">    // disable transformer for cache key generation</span><br><span class="line">    originContext[SDWebImageContextImageTransformer] = [NSNull null];</span><br><span class="line">    NSString *key = [self cacheKeyForURL:url context:originContext];</span><br><span class="line">    id&lt;SDImageTransformer&gt; transformer = context[SDWebImageContextImageTransformer];</span><br><span class="line">    if (![transformer conformsToProtocol:@protocol(SDImageTransformer)]) &#123;</span><br><span class="line">        transformer = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    id&lt;SDWebImageCacheSerializer&gt; cacheSerializer = context[SDWebImageContextCacheSerializer];</span><br><span class="line">    </span><br><span class="line">    BOOL shouldTransformImage = downloadedImage &amp;&amp; transformer;</span><br><span class="line">    shouldTransformImage = shouldTransformImage &amp;&amp; (!downloadedImage.sd_isAnimated || (options &amp; SDWebImageTransformAnimatedImage));</span><br><span class="line">    shouldTransformImage = shouldTransformImage &amp;&amp; (!downloadedImage.sd_isVector || (options &amp; SDWebImageTransformVectorImage));</span><br><span class="line">    BOOL shouldCacheOriginal = downloadedImage &amp;&amp; finished;</span><br><span class="line">    </span><br><span class="line">    // if available, store original image to cache</span><br><span class="line">    if (shouldCacheOriginal) &#123;</span><br><span class="line">        // normally use the store cache type, but if target image is transformed, use original store cache type instead</span><br><span class="line">        SDImageCacheType targetStoreCacheType = shouldTransformImage ? originalStoreCacheType : storeCacheType;</span><br><span class="line">        if (cacheSerializer &amp;&amp; (targetStoreCacheType == SDImageCacheTypeDisk || targetStoreCacheType == SDImageCacheTypeAll)) &#123;</span><br><span class="line">            dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">                @autoreleasepool &#123;</span><br><span class="line">                    NSData *cacheData = [cacheSerializer cacheDataWithImage:downloadedImage originalData:downloadedData imageURL:url];</span><br><span class="line">                    [self storeImage:downloadedImage imageData:cacheData forKey:key cacheType:targetStoreCacheType options:options context:context completion:^&#123;</span><br><span class="line">                        // Continue transform process</span><br><span class="line">                        [self callTransformProcessForOperation:operation url:url options:options context:context originalImage:downloadedImage originalData:downloadedData finished:finished progress:progressBlock completed:completedBlock];</span><br><span class="line">                    &#125;];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            [self storeImage:downloadedImage imageData:downloadedData forKey:key cacheType:targetStoreCacheType options:options context:context completion:^&#123;</span><br><span class="line">                // Continue transform process</span><br><span class="line">                [self callTransformProcessForOperation:operation url:url options:options context:context originalImage:downloadedImage originalData:downloadedData finished:finished progress:progressBlock completed:completedBlock];</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Continue transform process</span><br><span class="line">        [self callTransformProcessForOperation:operation url:url options:options context:context originalImage:downloadedImage originalData:downloadedData finished:finished progress:progressBlock completed:completedBlock];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Transform process</span><br><span class="line">- (void)callTransformProcessForOperation:(nonnull SDWebImageCombinedOperation *)operation</span><br><span class="line">                                     url:(nonnull NSURL *)url</span><br><span class="line">                                 options:(SDWebImageOptions)options</span><br><span class="line">                                 context:(SDWebImageContext *)context</span><br><span class="line">                           originalImage:(nullable UIImage *)originalImage</span><br><span class="line">                            originalData:(nullable NSData *)originalData</span><br><span class="line">                                finished:(BOOL)finished</span><br><span class="line">                                progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                               completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    // the target image store cache type</span><br><span class="line">    SDImageCacheType storeCacheType = SDImageCacheTypeAll;</span><br><span class="line">    if (context[SDWebImageContextStoreCacheType]) &#123;</span><br><span class="line">        storeCacheType = [context[SDWebImageContextStoreCacheType] integerValue];</span><br><span class="line">    &#125;</span><br><span class="line">    // transformed cache key</span><br><span class="line">    NSString *key = [self cacheKeyForURL:url context:context];</span><br><span class="line">    id&lt;SDImageTransformer&gt; transformer = context[SDWebImageContextImageTransformer];</span><br><span class="line">    if (![transformer conformsToProtocol:@protocol(SDImageTransformer)]) &#123;</span><br><span class="line">        transformer = nil;</span><br><span class="line">    &#125;</span><br><span class="line">    id&lt;SDWebImageCacheSerializer&gt; cacheSerializer = context[SDWebImageContextCacheSerializer];</span><br><span class="line">    </span><br><span class="line">    BOOL shouldTransformImage = originalImage &amp;&amp; transformer;</span><br><span class="line">    shouldTransformImage = shouldTransformImage &amp;&amp; (!originalImage.sd_isAnimated || (options &amp; SDWebImageTransformAnimatedImage));</span><br><span class="line">    shouldTransformImage = shouldTransformImage &amp;&amp; (!originalImage.sd_isVector || (options &amp; SDWebImageTransformVectorImage));</span><br><span class="line">    // if available, store transformed image to cache</span><br><span class="line">    if (shouldTransformImage) &#123;</span><br><span class="line">        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">            @autoreleasepool &#123;</span><br><span class="line">                UIImage *transformedImage = [transformer transformedImageWithImage:originalImage forKey:key];</span><br><span class="line">                if (transformedImage &amp;&amp; finished) &#123;</span><br><span class="line">                    BOOL imageWasTransformed = ![transformedImage isEqual:originalImage];</span><br><span class="line">                    NSData *cacheData;</span><br><span class="line">                    // pass nil if the image was transformed, so we can recalculate the data from the image</span><br><span class="line">                    if (cacheSerializer &amp;&amp; (storeCacheType == SDImageCacheTypeDisk || storeCacheType == SDImageCacheTypeAll)) &#123;</span><br><span class="line">                        cacheData = [cacheSerializer cacheDataWithImage:transformedImage originalData:(imageWasTransformed ? nil : originalData) imageURL:url];</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        cacheData = (imageWasTransformed ? nil : originalData);</span><br><span class="line">                    &#125;</span><br><span class="line">                    [self storeImage:transformedImage imageData:cacheData forKey:key cacheType:storeCacheType options:options context:context completion:^&#123;</span><br><span class="line">                        [self callCompletionBlockForOperation:operation completion:completedBlock image:transformedImage data:originalData error:nil cacheType:SDImageCacheTypeNone finished:finished url:url];</span><br><span class="line">                    &#125;];</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    [self callCompletionBlockForOperation:operation completion:completedBlock image:transformedImage data:originalData error:nil cacheType:SDImageCacheTypeNone finished:finished url:url];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [self callCompletionBlockForOperation:operation completion:completedBlock image:originalImage data:originalData error:nil cacheType:SDImageCacheTypeNone finished:finished url:url];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先检查内存是否有缓存，没有从磁盘查找，都没有开启一个图片下载任务，拿到图片数据缓存到内存，磁盘，磁盘查找源码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">- (nullable NSOperation *)queryCacheOperationForKey:(nullable NSString *)key options:(SDImageCacheOptions)options context:(nullable SDWebImageContext *)context cacheType:(SDImageCacheType)queryCacheType done:(nullable SDImageCacheQueryCompletionBlock)doneBlock &#123;</span><br><span class="line">    if (!key) &#123;</span><br><span class="line">        if (doneBlock) &#123;</span><br><span class="line">            doneBlock(nil, nil, SDImageCacheTypeNone);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    // Invalid cache type</span><br><span class="line">    if (queryCacheType == SDImageCacheTypeNone) &#123;</span><br><span class="line">        if (doneBlock) &#123;</span><br><span class="line">            doneBlock(nil, nil, SDImageCacheTypeNone);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // First check the in-memory cache...</span><br><span class="line">    UIImage *image;</span><br><span class="line">    if (queryCacheType != SDImageCacheTypeDisk) &#123;</span><br><span class="line">        image = [self imageFromMemoryCacheForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (image) &#123;</span><br><span class="line">        if (options &amp; SDImageCacheDecodeFirstFrameOnly) &#123;</span><br><span class="line">            // Ensure static image</span><br><span class="line">            Class animatedImageClass = image.class;</span><br><span class="line">            if (image.sd_isAnimated || ([animatedImageClass isSubclassOfClass:[UIImage class]] &amp;&amp; [animatedImageClass conformsToProtocol:@protocol(SDAnimatedImage)])) &#123;</span><br><span class="line">#if SD_MAC</span><br><span class="line">                image = [[NSImage alloc] initWithCGImage:image.CGImage scale:image.scale orientation:kCGImagePropertyOrientationUp];</span><br><span class="line">#else</span><br><span class="line">                image = [[UIImage alloc] initWithCGImage:image.CGImage scale:image.scale orientation:image.imageOrientation];</span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else if (options &amp; SDImageCacheMatchAnimatedImageClass) &#123;</span><br><span class="line">            // Check image class matching</span><br><span class="line">            Class animatedImageClass = image.class;</span><br><span class="line">            Class desiredImageClass = context[SDWebImageContextAnimatedImageClass];</span><br><span class="line">            if (desiredImageClass &amp;&amp; ![animatedImageClass isSubclassOfClass:desiredImageClass]) &#123;</span><br><span class="line">                image = nil;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL shouldQueryMemoryOnly = (queryCacheType == SDImageCacheTypeMemory) || (image &amp;&amp; !(options &amp; SDImageCacheQueryMemoryData));</span><br><span class="line">    if (shouldQueryMemoryOnly) &#123;</span><br><span class="line">        if (doneBlock) &#123;</span><br><span class="line">            doneBlock(image, nil, SDImageCacheTypeMemory);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // Second check the disk cache...</span><br><span class="line">    NSOperation *operation = [NSOperation new];</span><br><span class="line">    // Check whether we need to synchronously query disk</span><br><span class="line">    // 1. in-memory cache hit &amp; memoryDataSync</span><br><span class="line">    // 2. in-memory cache miss &amp; diskDataSync</span><br><span class="line">    BOOL shouldQueryDiskSync = ((image &amp;&amp; options &amp; SDImageCacheQueryMemoryDataSync) ||</span><br><span class="line">                                (!image &amp;&amp; options &amp; SDImageCacheQueryDiskDataSync));</span><br><span class="line">    void(^queryDiskBlock)(void) =  ^&#123;</span><br><span class="line">        if (operation.isCancelled) &#123;</span><br><span class="line">            if (doneBlock) &#123;</span><br><span class="line">                doneBlock(nil, nil, SDImageCacheTypeNone);</span><br><span class="line">            &#125;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        @autoreleasepool &#123;</span><br><span class="line">            NSData *diskData = [self diskImageDataBySearchingAllPathsForKey:key];</span><br><span class="line">            UIImage *diskImage;</span><br><span class="line">            SDImageCacheType cacheType = SDImageCacheTypeNone;</span><br><span class="line">            if (image) &#123;</span><br><span class="line">                // the image is from in-memory cache, but need image data</span><br><span class="line">                diskImage = image;</span><br><span class="line">                cacheType = SDImageCacheTypeMemory;</span><br><span class="line">            &#125; else if (diskData) &#123;</span><br><span class="line">                cacheType = SDImageCacheTypeDisk;</span><br><span class="line">                // decode image data only if in-memory cache missed</span><br><span class="line">                diskImage = [self diskImageForKey:key data:diskData options:options context:context];</span><br><span class="line">                if (diskImage &amp;&amp; self.config.shouldCacheImagesInMemory) &#123;</span><br><span class="line">                    NSUInteger cost = diskImage.sd_memoryCost;</span><br><span class="line">                    [self.memoryCache setObject:diskImage forKey:key cost:cost];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            if (doneBlock) &#123;</span><br><span class="line">                if (shouldQueryDiskSync) &#123;</span><br><span class="line">                    doneBlock(diskImage, diskData, cacheType);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                        doneBlock(diskImage, diskData, cacheType);</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    // Query in ioQueue to keep IO-safe</span><br><span class="line">    if (shouldQueryDiskSync) &#123;</span><br><span class="line">        dispatch_sync(self.ioQueue, queryDiskBlock);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dispatch_async(self.ioQueue, queryDiskBlock);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return operation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-8、AnimatedImage"><a href="#3-8、AnimatedImage" class="headerlink" title="3.8、AnimatedImage"></a>3.8、AnimatedImage</h3><p>类似<a href="https://github.com/Flipboard/FLAnimatedImage" target="_blank" rel="noopener">FLAnimatedImage</a>高性能播放GIF格式图片，对于大容量GIF图片，直接加载会导致内存暴涨，这点在我负责的APP深有体会，由于GIF图片过大，导致首次加载界面会出现卡顿，界面渲染延迟，后来换成了<a href="https://github.com/Flipboard/FLAnimatedImage" target="_blank" rel="noopener">FLAnimatedImage</a>，解决了播放GIF大图内存的问题。现在SDWebImage也提供了GI图片加载类，提高性能。</p>
<ul>
<li><strong>SDAnimatedImage</strong>：继承自UIImage</li>
<li><strong>SDAnimatedImageView</strong>：继承UIImageView，处理GIF图片播放</li>
<li><strong>SDAnimatedImageView+WebCache</strong>：提供类似普通图片加载API，加载网络或本地</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Set the imageView `image` with an `url`.</span><br><span class="line"> *</span><br><span class="line"> * The download is asynchronous and cached.</span><br><span class="line"> *</span><br><span class="line"> * @param url The url for the image.</span><br><span class="line"> */</span><br><span class="line">- (void)sd_setImageWithURL:(nullable NSURL *)url NS_REFINED_FOR_SWIFT;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>SDAnimatedImagePlayer</strong>：A player to control the playback of animated image, which can be used to drive Animated ImageView or any rendering usage, like CALayer/WatchKit/SwiftUI rendering.</li>
</ul>
<h3 id="3-9、Categories"><a href="#3-9、Categories" class="headerlink" title="3.9、Categories"></a>3.9、Categories</h3><p>图片相关分类</p>
<ul>
<li><strong>NSData+ImageContentType</strong>：图片格式判断，字符串转换</li>
<li><strong>UIImage+ExtendedCacheData</strong>：给图片关联数据，需遵循NSCoding协议</li>
<li><strong>UIImage+GIF</strong>：将二进制数据转化为GIF图片</li>
<li><strong>UIImage+Metadata</strong>： UIImage category for image metadata, including animation, loop count, format, incremental, etc.</li>
<li><strong>UIImage+MultiFormat</strong>：图片编码解码</li>
<li><strong>UIImage+ForceDecode</strong>：UIImage category about force decode feature (avoid Image/IO’s lazy decoding during rendering behavior).</li>
<li><strong>UIImage+Transform</strong>： Provide some commen method for <code>UIImage</code>.Image process is based on Core Graphics and vImage.</li>
<li><strong>UIImage+MemoryCacheCost</strong>：图片内存消耗</li>
<li><strong>NSImage+Compatibility</strong>：This category is provided to easily write cross-platform(AppKit/UIKit) code. For common usage, see <code>UIImage+Metadata.h</code></li>
<li><strong>UIView+WebCacheOperation</strong>：These methods are used to support canceling for UIView image loading, it’s designed to be used internal but not external. All the stored operations are weak, so it will be dalloced after image loading finished. If you need to store operations, use your own class to keep a strong reference for them.</li>
</ul>
<h3 id="3-10、WebCache-Categories"><a href="#3-10、WebCache-Categories" class="headerlink" title="3.10、WebCache Categories"></a>3.10、WebCache Categories</h3><p>支持图片设置UI控件设置图片分类。<strong>UIView+WebCache</strong>分类添加了图片主要设置逻辑。其次就是我们熟知的<strong>UIImageView+WebCache</strong>、<strong>UIImageView+HighlightedWebCache</strong>、<strong>UIButton+WebCache</strong>、<strong>NSButton+WebCache</strong>、</p>
<ul>
<li><strong>UIView+WebCache</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Set the imageView `image` with an `url` and optionally a placeholder image.</span><br><span class="line"> *</span><br><span class="line"> * The download is asynchronous and cached.</span><br><span class="line"> *</span><br><span class="line"> * @param url            The url for the image.</span><br><span class="line"> * @param placeholder    The image to be set initially, until the image request finishes.</span><br><span class="line"> * @param options        The options to use when downloading the image. @see SDWebImageOptions for the possible values.</span><br><span class="line"> * @param context        A context contains different options to perform specify changes or processes, see `SDWebImageContextOption`. This hold the extra objects which `options` enum can not hold.</span><br><span class="line"> * @param setImageBlock  Block used for custom set image code. If not provide, use the built-in set image code (supports `UIImageView/NSImageView` and `UIButton/NSButton` currently)</span><br><span class="line"> * @param progressBlock  A block called while image is downloading</span><br><span class="line"> *                       @note the progress block is executed on a background queue</span><br><span class="line"> * @param completedBlock A block called when operation has been completed.</span><br><span class="line"> *   This block has no return value and takes the requested UIImage as first parameter and the NSData representation as second parameter.</span><br><span class="line"> *   In case of error the image parameter is nil and the third parameter may contain an NSError.</span><br><span class="line"> *</span><br><span class="line"> *   The forth parameter is an `SDImageCacheType` enum indicating if the image was retrieved from the local cache</span><br><span class="line"> *   or from the memory cache or from the network.</span><br><span class="line"> *</span><br><span class="line"> *   The fith parameter normally is always YES. However, if you provide SDWebImageAvoidAutoSetImage with SDWebImageProgressiveLoad options to enable progressive downloading and set the image yourself. This block is thus called repeatedly with a partial image. When image is fully downloaded, the</span><br><span class="line"> *   block is called a last time with the full image and the last parameter set to YES.</span><br><span class="line"> *</span><br><span class="line"> *   The last parameter is the original image URL</span><br><span class="line"> */</span><br><span class="line">- (void)sd_internalSetImageWithURL:(nullable NSURL *)url</span><br><span class="line">                  placeholderImage:(nullable UIImage *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                           context:(nullable SDWebImageContext *)context</span><br><span class="line">                     setImageBlock:(nullable SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(nullable SDInternalCompletionBlock)completedBlock;</span><br><span class="line">/**</span><br><span class="line"> * Cancel the current image load</span><br><span class="line"> */</span><br><span class="line">- (void)sd_cancelCurrentImageLoad;</span><br><span class="line"></span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line"></span><br><span class="line">#pragma mark - Image Transition</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The image transition when image load finished. See `SDWebImageTransition`.</span><br><span class="line"> If you specify nil, do not do transition. Defautls to nil.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong, nullable) SDWebImageTransition *sd_imageTransition;</span><br><span class="line"></span><br><span class="line">#pragma mark - Image Indicator</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The image indicator during the image loading. If you do not need indicator, specify nil. Defaults to nil</span><br><span class="line"> The setter will remove the old indicator view and add new indicator view to current view&apos;s subview.</span><br><span class="line"> @note Because this is UI related, you should access only from the main queue.</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong, nullable) id&lt;SDWebImageIndicator&gt; sd_imageIndicator;</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>方法实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br></pre></td><td class="code"><pre><span class="line">- (void)sd_internalSetImageWithURL:(nullable NSURL *)url</span><br><span class="line">                  placeholderImage:(nullable UIImage *)placeholder</span><br><span class="line">                           options:(SDWebImageOptions)options</span><br><span class="line">                           context:(nullable SDWebImageContext *)context</span><br><span class="line">                     setImageBlock:(nullable SDSetImageBlock)setImageBlock</span><br><span class="line">                          progress:(nullable SDImageLoaderProgressBlock)progressBlock</span><br><span class="line">                         completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</span><br><span class="line">    if (context) &#123;</span><br><span class="line">        // copy to avoid mutable object</span><br><span class="line">        context = [context copy];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        context = [NSDictionary dictionary];</span><br><span class="line">    &#125;</span><br><span class="line">    NSString *validOperationKey = context[SDWebImageContextSetImageOperationKey];</span><br><span class="line">    if (!validOperationKey) &#123;</span><br><span class="line">        // pass through the operation key to downstream, which can used for tracing operation or image view class</span><br><span class="line">        validOperationKey = NSStringFromClass([self class]);</span><br><span class="line">        SDWebImageMutableContext *mutableContext = [context mutableCopy];</span><br><span class="line">        mutableContext[SDWebImageContextSetImageOperationKey] = validOperationKey;</span><br><span class="line">        context = [mutableContext copy];</span><br><span class="line">    &#125;</span><br><span class="line">    self.sd_latestOperationKey = validOperationKey;</span><br><span class="line">    /// 取消上一次的下载任务</span><br><span class="line">    [self sd_cancelImageLoadOperationWithKey:validOperationKey];</span><br><span class="line">    self.sd_imageURL = url;</span><br><span class="line">    </span><br><span class="line">    /// 如果不延迟加载展位图，就先显示占位图</span><br><span class="line">    if (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            [self sd_setImage:placeholder imageData:nil basedOnClassOrViaCustomSetImageBlock:setImageBlock cacheType:SDImageCacheTypeNone imageURL:url];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (url) &#123;</span><br><span class="line">        // reset the progress</span><br><span class="line">        NSProgress *imageProgress = objc_getAssociatedObject(self, @selector(sd_imageProgress));</span><br><span class="line">        if (imageProgress) &#123;</span><br><span class="line">            imageProgress.totalUnitCount = 0;</span><br><span class="line">            imageProgress.completedUnitCount = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">        // check and start image indicator</span><br><span class="line">        [self sd_startImageIndicator];</span><br><span class="line">        id&lt;SDWebImageIndicator&gt; imageIndicator = self.sd_imageIndicator;</span><br><span class="line">#endif</span><br><span class="line">        SDWebImageManager *manager = context[SDWebImageContextCustomManager];</span><br><span class="line">        if (!manager) &#123;</span><br><span class="line">            manager = [SDWebImageManager sharedManager];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // remove this manager to avoid retain cycle (manger -&gt; loader -&gt; operation -&gt; context -&gt; manager)</span><br><span class="line">            SDWebImageMutableContext *mutableContext = [context mutableCopy];</span><br><span class="line">            mutableContext[SDWebImageContextCustomManager] = nil;</span><br><span class="line">            context = [mutableContext copy];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        SDImageLoaderProgressBlock combinedProgressBlock = ^(NSInteger receivedSize, NSInteger expectedSize, NSURL * _Nullable targetURL) &#123;</span><br><span class="line">            if (imageProgress) &#123;</span><br><span class="line">                imageProgress.totalUnitCount = expectedSize;</span><br><span class="line">                imageProgress.completedUnitCount = receivedSize;</span><br><span class="line">            &#125;</span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">            if ([imageIndicator respondsToSelector:@selector(updateIndicatorProgress:)]) &#123;</span><br><span class="line">                double progress = 0;</span><br><span class="line">                if (expectedSize != 0) &#123;</span><br><span class="line">                    progress = (double)receivedSize / expectedSize;</span><br><span class="line">                &#125;</span><br><span class="line">                progress = MAX(MIN(progress, 1), 0); // 0.0 - 1.0</span><br><span class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    [imageIndicator updateIndicatorProgress:progress];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">          /// 回调下载进度  </span><br><span class="line">          if (progressBlock) &#123;</span><br><span class="line">                progressBlock(receivedSize, expectedSize, targetURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        @weakify(self);</span><br><span class="line">        id &lt;SDWebImageOperation&gt; operation = [manager loadImageWithURL:url options:options context:context progress:combinedProgressBlock completed:^(UIImage *image, NSData *data, NSError *error, SDImageCacheType cacheType, BOOL finished, NSURL *imageURL) &#123;</span><br><span class="line">            @strongify(self);</span><br><span class="line">            if (!self) &#123; return; &#125;</span><br><span class="line">            // if the progress not been updated, mark it to complete state</span><br><span class="line">            if (imageProgress &amp;&amp; finished &amp;&amp; !error &amp;&amp; imageProgress.totalUnitCount == 0 &amp;&amp; imageProgress.completedUnitCount == 0) &#123;</span><br><span class="line">                imageProgress.totalUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">                imageProgress.completedUnitCount = SDWebImageProgressUnitCountUnknown;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">            // check and stop image indicator</span><br><span class="line">            if (finished) &#123;</span><br><span class="line">                [self sd_stopImageIndicator];</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">            </span><br><span class="line">            BOOL shouldCallCompletedBlock = finished || (options &amp; SDWebImageAvoidAutoSetImage);</span><br><span class="line">            BOOL shouldNotSetImage = ((image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage)) ||</span><br><span class="line">                                      (!image &amp;&amp; !(options &amp; SDWebImageDelayPlaceholder)));</span><br><span class="line">            SDWebImageNoParamsBlock callCompletedBlockClojure = ^&#123;</span><br><span class="line">                if (!self) &#123; return; &#125;</span><br><span class="line">                if (!shouldNotSetImage) &#123;</span><br><span class="line">                    [self sd_setNeedsLayout];</span><br><span class="line">                &#125;</span><br><span class="line">                if (completedBlock &amp;&amp; shouldCallCompletedBlock) &#123;</span><br><span class="line">                    completedBlock(image, data, error, cacheType, finished, url);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            </span><br><span class="line">            // case 1a: we got an image, but the SDWebImageAvoidAutoSetImage flag is set</span><br><span class="line">            // OR</span><br><span class="line">            // case 1b: we got no image and the SDWebImageDelayPlaceholder is not set</span><br><span class="line">            if (shouldNotSetImage) &#123;</span><br><span class="line">                dispatch_main_async_safe(callCompletedBlockClojure);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            UIImage *targetImage = nil;</span><br><span class="line">            NSData *targetData = nil;</span><br><span class="line">            if (image) &#123;</span><br><span class="line">                // case 2a: we got an image and the SDWebImageAvoidAutoSetImage is not set</span><br><span class="line">                targetImage = image;</span><br><span class="line">                targetData = data;</span><br><span class="line">            &#125; else if (options &amp; SDWebImageDelayPlaceholder) &#123;</span><br><span class="line">                // case 2b: we got no image and the SDWebImageDelayPlaceholder flag is set</span><br><span class="line">                targetImage = placeholder;</span><br><span class="line">                targetData = nil;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">            // check whether we should use the image transition</span><br><span class="line">            SDWebImageTransition *transition = nil;</span><br><span class="line">            if (finished &amp;&amp; (options &amp; SDWebImageForceTransition || cacheType == SDImageCacheTypeNone)) &#123;</span><br><span class="line">                transition = self.sd_imageTransition;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">            dispatch_main_async_safe(^&#123;</span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">                /// 设置缓存或网络加载图片</span><br><span class="line">                [self sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</span><br><span class="line">#else</span><br><span class="line">                [self sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock cacheType:cacheType imageURL:imageURL];</span><br><span class="line">#endif</span><br><span class="line">                callCompletedBlockClojure();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;];</span><br><span class="line">        </span><br><span class="line">        /// 存储图片下载operation</span><br><span class="line">        [self sd_setImageLoadOperation:operation forKey:validOperationKey];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">        [self sd_stopImageIndicator];</span><br><span class="line">#endif</span><br><span class="line">        dispatch_main_async_safe(^&#123;</span><br><span class="line">            if (completedBlock) &#123;</span><br><span class="line">                NSError *error = [NSError errorWithDomain:SDWebImageErrorDomain code:SDWebImageErrorInvalidURL userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Image url is nil&quot;&#125;];</span><br><span class="line">                completedBlock(nil, nil, error, SDImageCacheTypeNone, YES, url);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)sd_setImage:(UIImage *)image imageData:(NSData *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock cacheType:(SDImageCacheType)cacheType imageURL:(NSURL *)imageURL &#123;</span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">    [self sd_setImage:image imageData:imageData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:nil cacheType:cacheType imageURL:imageURL];</span><br><span class="line">#else</span><br><span class="line">    // watchOS does not support view transition. Simplify the logic</span><br><span class="line">    if (setImageBlock) &#123;</span><br><span class="line">        setImageBlock(image, imageData, cacheType, imageURL);</span><br><span class="line">    &#125; else if ([self isKindOfClass:[UIImageView class]]) &#123;</span><br><span class="line">        UIImageView *imageView = (UIImageView *)self;</span><br><span class="line">        [imageView setImage:image];</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#if SD_UIKIT || SD_MAC</span><br><span class="line">- (void)sd_setImage:(UIImage *)image imageData:(NSData *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock transition:(SDWebImageTransition *)transition cacheType:(SDImageCacheType)cacheType imageURL:(NSURL *)imageURL &#123;</span><br><span class="line">    UIView *view = self;</span><br><span class="line">    SDSetImageBlock finalSetImageBlock;</span><br><span class="line">    if (setImageBlock) &#123;</span><br><span class="line">        finalSetImageBlock = setImageBlock;</span><br><span class="line">    &#125; else if ([view isKindOfClass:[UIImageView class]]) &#123;</span><br><span class="line">        UIImageView *imageView = (UIImageView *)view;</span><br><span class="line">        finalSetImageBlock = ^(UIImage *setImage, NSData *setImageData, SDImageCacheType setCacheType, NSURL *setImageURL) &#123;</span><br><span class="line">            imageView.image = setImage;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">#if SD_UIKIT</span><br><span class="line">    else if ([view isKindOfClass:[UIButton class]]) &#123;</span><br><span class="line">        UIButton *button = (UIButton *)view;</span><br><span class="line">        finalSetImageBlock = ^(UIImage *setImage, NSData *setImageData, SDImageCacheType setCacheType, NSURL *setImageURL) &#123;</span><br><span class="line">            [button setImage:setImage forState:UIControlStateNormal];</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">#if SD_MAC</span><br><span class="line">    else if ([view isKindOfClass:[NSButton class]]) &#123;</span><br><span class="line">        NSButton *button = (NSButton *)view;</span><br><span class="line">        finalSetImageBlock = ^(UIImage *setImage, NSData *setImageData, SDImageCacheType setCacheType, NSURL *setImageURL) &#123;</span><br><span class="line">            button.image = setImage;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    if (transition) &#123;</span><br><span class="line">#if SD_UIKIT</span><br><span class="line">        [UIView transitionWithView:view duration:0 options:0 animations:^&#123;</span><br><span class="line">            // 0 duration to let UIKit render placeholder and prepares block</span><br><span class="line">            if (transition.prepares) &#123;</span><br><span class="line">                transition.prepares(view, image, imageData, cacheType, imageURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; completion:^(BOOL finished) &#123;</span><br><span class="line">            [UIView transitionWithView:view duration:transition.duration options:transition.animationOptions animations:^&#123;</span><br><span class="line">                if (finalSetImageBlock &amp;&amp; !transition.avoidAutoSetImage) &#123;</span><br><span class="line">                    finalSetImageBlock(image, imageData, cacheType, imageURL);</span><br><span class="line">                &#125;</span><br><span class="line">                if (transition.animations) &#123;</span><br><span class="line">                    transition.animations(view, image);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; completion:transition.completion];</span><br><span class="line">        &#125;];</span><br><span class="line">#elif SD_MAC</span><br><span class="line">        [NSAnimationContext runAnimationGroup:^(NSAnimationContext * _Nonnull prepareContext) &#123;</span><br><span class="line">            // 0 duration to let AppKit render placeholder and prepares block</span><br><span class="line">            prepareContext.duration = 0;</span><br><span class="line">            if (transition.prepares) &#123;</span><br><span class="line">                transition.prepares(view, image, imageData, cacheType, imageURL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; completionHandler:^&#123;</span><br><span class="line">            [NSAnimationContext runAnimationGroup:^(NSAnimationContext * _Nonnull context) &#123;</span><br><span class="line">                context.duration = transition.duration;</span><br><span class="line">                #pragma clang diagnostic push</span><br><span class="line">                #pragma clang diagnostic ignored &quot;-Wdeprecated-declarations&quot;</span><br><span class="line">                CAMediaTimingFunction *timingFunction = transition.timingFunction;</span><br><span class="line">                #pragma clang diagnostic pop</span><br><span class="line">                if (!timingFunction) &#123;</span><br><span class="line">                    timingFunction = SDTimingFunctionFromAnimationOptions(transition.animationOptions);</span><br><span class="line">                &#125;</span><br><span class="line">                context.timingFunction = timingFunction;</span><br><span class="line">                context.allowsImplicitAnimation = SD_OPTIONS_CONTAINS(transition.animationOptions, SDWebImageAnimationOptionAllowsImplicitAnimation);</span><br><span class="line">                if (finalSetImageBlock &amp;&amp; !transition.avoidAutoSetImage) &#123;</span><br><span class="line">                    finalSetImageBlock(image, imageData, cacheType, imageURL);</span><br><span class="line">                &#125;</span><br><span class="line">                CATransition *trans = SDTransitionFromAnimationOptions(transition.animationOptions);</span><br><span class="line">                if (trans) &#123;</span><br><span class="line">                    [view.layer addAnimation:trans forKey:kCATransition];</span><br><span class="line">                &#125;</span><br><span class="line">                if (transition.animations) &#123;</span><br><span class="line">                    transition.animations(view, image);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; completionHandler:^&#123;</span><br><span class="line">                if (transition.completion) &#123;</span><br><span class="line">                    transition.completion(YES);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;];</span><br><span class="line">#endif</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (finalSetImageBlock) &#123;</span><br><span class="line">            finalSetImageBlock(image, imageData, cacheType, imageURL);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p>取消下载任务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (void)sd_cancelImageLoadOperationWithKey:(nullable NSString *)key &#123;</span><br><span class="line">    if (key) &#123;</span><br><span class="line">        // Cancel in progress downloader from queue</span><br><span class="line">        SDOperationsDictionary *operationDictionary = [self sd_operationDictionary];</span><br><span class="line">        id&lt;SDWebImageOperation&gt; operation;</span><br><span class="line">        </span><br><span class="line">        @synchronized (self) &#123;</span><br><span class="line">            operation = [operationDictionary objectForKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">        if (operation) &#123;</span><br><span class="line">            if ([operation conformsToProtocol:@protocol(SDWebImageOperation)]) &#123;</span><br><span class="line">                [operation cancel];</span><br><span class="line">            &#125;</span><br><span class="line">            @synchronized (self) &#123;</span><br><span class="line">                [operationDictionary removeObjectForKey:key];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总的来说，5.0之后的版本，图片设置分类代码简化了许多，因为相关逻辑都被抽离到了Manager里，分类里之需关注方法调用，不用再处理复杂图片的查询，下载，缓存等逻辑。</p>
<h3 id="3-11、SDWebImageMapKit"><a href="#3-11、SDWebImageMapKit" class="headerlink" title="3.11、SDWebImageMapKit"></a>3.11、SDWebImageMapKit</h3><p>主要为MKAnnotationView添加了设置图片分类。</p>
<h2 id="四、软件架构设计需知识储备"><a href="#四、软件架构设计需知识储备" class="headerlink" title="四、软件架构设计需知识储备"></a>四、软件架构设计需知识储备</h2><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlly1gfjtj8emsuj311p0u0478.jpg" alt=""></p>
<p>对源码阅读一遍，我所理解的设计图片加载库所需要的知识储备</p>
<blockquote>
<ul>
<li>CocoTouch各种framework</li>
<li>多线程</li>
<li>图片编/解码</li>
<li>网络</li>
<li>文件系统</li>
<li>跨平台适配</li>
<li>设计模式</li>
<li>软件设计原则</li>
<li>算法</li>
</ul>
</blockquote>
<h2 id="五、相关插件"><a href="#五、相关插件" class="headerlink" title="五、相关插件"></a>五、相关插件</h2><h3 id="Coders-for-additional-image-formats"><a href="#Coders-for-additional-image-formats" class="headerlink" title="Coders for additional image formats"></a>Coders for additional image formats</h3><table>
<thead>
<tr>
<th style="text-align:center">Plugin</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageWebPCoder" target="_blank" rel="noopener">SDWebImageWebPCoder</a></td>
<td style="text-align:center">coder for WebP format. Based on <a href="https://chromium.googlesource.com/webm/libwebp" target="_blank" rel="noopener">libwebp</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageHEIFCoder" target="_blank" rel="noopener">SDWebImageHEIFCoder</a></td>
<td style="text-align:center">coder for HEIF format, iOS 8+/macOS 10.10+ support. Based on <a href="https://github.com/strukturag/libheif" target="_blank" rel="noopener">libheif</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageBPGCoder" target="_blank" rel="noopener">SDWebImageBPGCoder</a></td>
<td style="text-align:center">coder for BPG format. Based on <a href="https://github.com/mirrorer/libbpg" target="_blank" rel="noopener">libbpg</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageFLIFCoder" target="_blank" rel="noopener">SDWebImageFLIFCoder</a></td>
<td style="text-align:center">coder for FLIF format. Based on <a href="https://github.com/FLIF-hub/FLIF" target="_blank" rel="noopener">libflif</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageAVIFCoder" target="_blank" rel="noopener">SDWebImageAVIFCoder</a></td>
<td style="text-align:center">coder for AVIF (AV1-based) format. Based on <a href="https://github.com/AOMediaCodec/libavif" target="_blank" rel="noopener">libavif</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImagePDFCoder" target="_blank" rel="noopener">SDWebImagePDFCoder</a></td>
<td style="text-align:center">coder for PDF vector format. Using built-in frameworks</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageSVGCoder" target="_blank" rel="noopener">SDWebImageSVGCoder</a></td>
<td style="text-align:center">coder for SVG vector format. Using built-in frameworks</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageLottieCoder" target="_blank" rel="noopener">SDWebImageLottieCoder</a></td>
<td style="text-align:center">coder for Lottie animation format. Based on <a href="https://github.com/Samsung/rlottie" target="_blank" rel="noopener">rlottie</a></td>
</tr>
</tbody>
</table>
<h3 id="Custom-Caches"><a href="#Custom-Caches" class="headerlink" title="Custom Caches"></a>Custom Caches</h3><table>
<thead>
<tr>
<th style="text-align:center">Plugin</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageYYPlugin" target="_blank" rel="noopener">SDWebImageYYPlugin</a></td>
<td style="text-align:center">plugin to support caching images with <a href="https://github.com/ibireme/YYCache" target="_blank" rel="noopener">YYCache</a></td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImagePINPlugin" target="_blank" rel="noopener">SDWebImagePINPlugin</a></td>
<td style="text-align:center">plugin to support caching images with <a href="https://github.com/pinterest/PINCache" target="_blank" rel="noopener">PINCache</a></td>
</tr>
</tbody>
</table>
<h3 id="Custom-Loaders"><a href="#Custom-Loaders" class="headerlink" title="Custom Loaders"></a>Custom Loaders</h3><table>
<thead>
<tr>
<th style="text-align:center">Plugin</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImagePhotosPlugin" target="_blank" rel="noopener">SDWebImagePhotosPlugin</a></td>
<td style="text-align:center">plugin to support loading images from Photos (using <code>Photos.framework</code>)</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageLinkPlugin" target="_blank" rel="noopener">SDWebImageLinkPlugin</a></td>
<td style="text-align:center">plugin to support loading images from rich link url, as well as <code>LPLinkView</code> (using <code>LinkPresentation.framework</code>)</td>
</tr>
</tbody>
</table>
<h3 id="Integration-with-3rd-party-libraries"><a href="#Integration-with-3rd-party-libraries" class="headerlink" title="Integration with 3rd party libraries"></a>Integration with 3rd party libraries</h3><table>
<thead>
<tr>
<th style="text-align:center">Plugin</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageLottiePlugin" target="_blank" rel="noopener">SDWebImageLottiePlugin</a></td>
<td style="text-align:center">plugin to support <a href="https://github.com/airbnb/lottie-ios" target="_blank" rel="noopener">Lottie-iOS</a>, vector animation rending with remote JSON files</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageLottiePlugin" target="_blank" rel="noopener">SDWebImageSVGKitPlugin</a></td>
<td style="text-align:center">plugin to support <a href="https://github.com/SVGKit/SVGKit" target="_blank" rel="noopener">SVGKit</a>, SVG rendering using Core Animation, iOS 8+/macOS 10.10+ support</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageFLPlugin" target="_blank" rel="noopener">SDWebImageFLPlugin</a></td>
<td style="text-align:center">plugin to support <a href="https://github.com/Flipboard/FLAnimatedImage" target="_blank" rel="noopener">FLAnimatedImage</a> as the engine for animated GIFs</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/SDWebImage/SDWebImageYYPlugin" target="_blank" rel="noopener">SDWebImageYYPlugin</a></td>
<td style="text-align:center">plugin to integrate <a href="https://github.com/ibireme/YYImage" target="_blank" rel="noopener">YYImage</a> &amp; <a href="https://github.com/ibireme/YYCache" target="_blank" rel="noopener">YYCache</a> for image rendering &amp; caching</td>
</tr>
</tbody>
</table>
<h2 id="六、结语"><a href="#六、结语" class="headerlink" title="六、结语"></a>六、结语</h2><blockquote>
<p>到这里，对源码的解读也就告一段落了。最新版本的架构设计也更加合理，使用协议，使扩展相当灵活，也更容易插件化，对各个功能能够轻松实现替换。框架图片编码解码处理，对于现在的我来说，理解还是有些吃力，总的来说，这次的源码阅读，我收获颇多，好的框架，更易于让人使用，阅读，理解，希望自己在以后编码设计中，能够汲取其优秀的编程设计思想，灵活运用。以后有时间，也会继续阅读源码，相信每次阅读，都会有新的体会与收获。如文章有解读不对的地方，希望能批评指正。</p>
</blockquote>
<hr>

      
    </div>
    
    
    

<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
  
</div>

<div>
      
        
      
</div>

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"><i class="fa fa-tag"></i> iOS</a>
          
            <a href="/tags/SDWebImage/" rel="tag"><i class="fa fa-tag"></i> SDWebImage</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        
          <div class="wp_rating">
<div style="color: rgba(0, 0, 0, 0.75); font-size:13px; letter-spacing:3px">(&gt;看完记得五星好评哦亲&lt;)</div>
            <div id="wpac-rating"></div>
          </div>
        

        

        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/06/设计模式/" rel="next" title="设计模式">
                <i class="fa fa-chevron-left"></i> 设计模式
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
      <!--MOB SHARE BEGIN-->
<div class="-hoofoo-share-title">分享到：</div>
<div class="-hoofoo-share-buttons">
    <div class="-mob-share-weibo -hoofoo-share-weibo -hoofoo-share-ui-button"><i class="fa fa-weibo" aria-hidden="true"></i></div>
    <div class="-mob-share-weixin -hoofoo-share-weixin -hoofoo-share-ui-button"><i class="fa fa-weixin" aria-hidden="true"></i></div>
    <div class="-mob-share-qq -hoofoo-share-qq -hoofoo-share-ui-button"><i class="fa fa-qq" aria-hidden="true"></i></div>
    <div class="-mob-share-twitter -hoofoo-share-twitter -hoofoo-share-ui-button"><i class="fa fa-twitter" aria-hidden="true"></i></div>
    <div class="-hoofoo-share-more -hoofoo-share-ui-button -mob-share-open"><i class="fa fa-ellipsis-h" aria-hidden="true"></i></div>
</div>
<div class="-mob-share-ui" style="display: none">
    <ul class="-mob-share-list">
        <li class="-mob-share-weibo"><p>新浪微博</p></li>
        <li class="-mob-share-weixin"><p>微信</p></li>
        <li class="-mob-share-qzone"><p>QQ空间</p></li>
        <li class="-mob-share-qq"><p>QQ好友</p></li>
        <li class="-mob-share-tencentweibo"><p>腾讯微博</p></li>
        <li class="-mob-share-renren"><p>人人网</p></li>
        <li class="-mob-share-kaixin"><p>开心网</p></li>
        <li class="-mob-share-douban"><p>豆瓣</p></li>
        <li class="-mob-share-youdao"><p>有道云笔记</p></li>
        <li class="-mob-share-mingdao"><p>明道</p></li>
        <li class="-mob-share-pengyou"><p>朋友网</p></li>
        <li class="-mob-share-facebook"><p>Facebook</p></li>
        <li class="-mob-share-twitter"><p>Twitter</p></li>
        <li class="-mob-share-pocket"><p>Pocket</p></li>
        <li class="-mob-share-google"><p>Google+</p></li>
        <li class="-mob-share-tumblr"><p>Tumblr</p></li>
        <li class="-mob-share-instapaper"><p>Instapaper</p></li>
        <li class="-mob-share-linkedin"><p>Linkedin</p></li>
    </ul>
    <div class="-mob-share-close">取消</div>
</div>
<div class="-mob-share-ui-bg"></div>
<script id="-mob-share" src="https://f1.webshare.mob.com/code/mob-share.js?appkey=26bd318095f14"></script>
<!--MOB SHARE END-->

    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMzQyMy85OTc5"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://upload.jianshu.io/users/upload_avatars/3072214/ccbcba49-0a5c-4b7e-b1e4-aea15ab4419f.png?imageMogr2/auto-orient/strip|imageView2/1/w/240/h/240"
                alt="Mr.Wen" />
            
              <p class="site-author-name" itemprop="name">Mr.Wen</p>
              <p class="site-description motion-element" itemprop="description">To strive, to seek, to find, and not to yield</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">31</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/wenmobo" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-GitHub"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="wenmobo2018@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/63445e24e8bf" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-heartbeat"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://juejin.im/user/5a371ae551882512d0607108" target="_blank" title="掘金">
                      
                        <i class="fa fa-fw fa-spinner"></i>掘金</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.apple.com/swift/" title="Swift 4" target="_blank">Swift 4</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://developer.apple.com/documentation/objectivec" title="Objective-C" target="_blank">Objective-C</a>
                  </li>
                
              </ul>
            </div>
          

          <div id="days"></div>
</script>
<script language="javascript">
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("10/01/2017 00:00:00");
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=setzero(Math.floor(e_hrsold));
e_minsold=(e_hrsold-hrsold)*60;
minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
seconds=setzero(Math.floor((e_minsold-minsold)*60));
document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
if (i<10)
{i="0" + i};
return i;
}
show_date_time();
</script>

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、前言"><span class="nav-number">1.</span> <span class="nav-text">一、前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、官方架构图解"><span class="nav-number">2.</span> <span class="nav-text">二、官方架构图解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#High-Level-Diagram"><span class="nav-number">2.1.</span> <span class="nav-text">High Level Diagram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Overall-Class-Diagram"><span class="nav-number">2.2.</span> <span class="nav-text">Overall Class Diagram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Top-Level-API-Diagram"><span class="nav-number">2.3.</span> <span class="nav-text">Top Level API Diagram</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Main-Sequence-Diagram"><span class="nav-number">2.4.</span> <span class="nav-text">Main Sequence Diagram</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、思维导图"><span class="nav-number">3.</span> <span class="nav-text">三、思维导图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1、Utils"><span class="nav-number">3.1.</span> <span class="nav-text">3.1、Utils</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2、Private"><span class="nav-number">3.2.</span> <span class="nav-text">3.2、Private</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3、Cache"><span class="nav-number">3.3.</span> <span class="nav-text">3.3、Cache</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4、Prefetcher"><span class="nav-number">3.4.</span> <span class="nav-text">3.4、Prefetcher</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5、Transformer"><span class="nav-number">3.5.</span> <span class="nav-text">3.5、Transformer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6、Downloader"><span class="nav-number">3.6.</span> <span class="nav-text">3.6、Downloader</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5、Decoder"><span class="nav-number">3.7.</span> <span class="nav-text">3.5、Decoder</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7、Manager"><span class="nav-number">3.8.</span> <span class="nav-text">3.7、Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8、AnimatedImage"><span class="nav-number">3.9.</span> <span class="nav-text">3.8、AnimatedImage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9、Categories"><span class="nav-number">3.10.</span> <span class="nav-text">3.9、Categories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-10、WebCache-Categories"><span class="nav-number">3.11.</span> <span class="nav-text">3.10、WebCache Categories</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-11、SDWebImageMapKit"><span class="nav-number">3.12.</span> <span class="nav-text">3.11、SDWebImageMapKit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、软件架构设计需知识储备"><span class="nav-number">4.</span> <span class="nav-text">四、软件架构设计需知识储备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、相关插件"><span class="nav-number">5.</span> <span class="nav-text">五、相关插件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Coders-for-additional-image-formats"><span class="nav-number">5.1.</span> <span class="nav-text">Coders for additional image formats</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Caches"><span class="nav-number">5.2.</span> <span class="nav-text">Custom Caches</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Custom-Loaders"><span class="nav-number">5.3.</span> <span class="nav-text">Custom Loaders</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Integration-with-3rd-party-libraries"><span class="nav-number">5.4.</span> <span class="nav-text">Integration with 3rd party libraries</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、结语"><span class="nav-number">6.</span> <span class="nav-text">六、结语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="heart">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Mr.Wen</span>

  
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数：<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<span class="post-meta-divider">|</span>

<!--
  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>



-->

<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共43.2k字</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("dSEzksBvVcKjRW17O9ks40ew-gzGzoHsz", "x5zy0MVMa4Ch9FK2rOxXjM4q");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
  <script type="text/javascript">
  wpac_init = window.wpac_init || [];
  wpac_init.push({widget: 'Rating', id: 12509,
    el: 'wpac-rating',
    color: 'fc6423'
  });
  (function() {
    if ('WIDGETPACK_LOADED' in window) return;
    WIDGETPACK_LOADED = true;
    var mc = document.createElement('script');
    mc.type = 'text/javascript';
    mc.async = true;
    mc.src = '//embed.widgetpack.com/widget.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
  })();
  </script>


  

  

  

  
<script type="text/javascript">
    //微信二维码点击背景关闭
    $('body').delegate('.-mob-share-weixin-qrcode-bg','click', function(){
         $(".-mob-share-weixin-qrcode-close").trigger("click");
    }); 
</script>




  <script type="text/javascript" color="250,100,49" opacity='0.5' zIndex="-1" count="150" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</body>
</html>
